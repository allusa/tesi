

\chapter{Implementació amb Python}


\todo{mirar}
\url{http://en.wikipedia.org/wiki/Design_Patterns}


La implementació de referència dels models de SGST i SGSTM es realitza
amb Python \parencite{python:doc2}. L'objectiu d'aquesta implementació
de referència és mantenir la fidelitat al model per tal de poder
experimentar-hi amb tota la potència matemàtica .

En la implementació s'afegeixen alguns operadors que en el model no
estaven explícitament definits perquè són propis de l'àlgebra de
conjunts. Alguns dels operadors principals que s'han d'afegir són els
relacionats amb la notació de creació de
conjunts, %set-builder notation (set comprehension)
els quals en els SGBD s'inclouen en el que es coneix com a
\emph{llenguatge de definició de dades} (DDL, de l'anglès \emph{data
  definition language}).
% El model s'ha descrit utilitzant àlgebra de conjunts. Així moltes operacions no s'han hagut de definir perquè formen part de la notació de conjunts: definició de nous conjunts (set builder notation), operació d'assignació, manipulació de les dades amb inserció, modificació, esborrar (perquè en àlgebra de conjunts es treballa amb immutabilitat ja que a l'àlgebra crear un nou conjunt no té cap cost), etc.  A les implementacions, però, totes aquestes operacions s'han de definir en cas que es vulguin.





Implementem els dos models de SGST i SGSTM com a dues biblioteques
diferents: \emph{Pytsms} i \emph{RoundRobinson} respectivament. La
RoundRobinson, però, té una forta dependència en la
Pytsms de la mateixa manera que hem definit els SGSTM en base
als SGST.


Utilitzem orientació a objectes. Ens permet fer explicita la relació
entre la implementació i el model. \todo{més explicat}

Utilitzem diagrames UML per a definir l'estructura de classes. Principalment volem mostrar les relacions entre les diverses classes.\todo{més explicat}


Implementem la part essencial, és a dir l'àlgebra definida en els
models lògics. No implementem els complements habituals dels SGBD, els
quals són necessaris en entorns d'explotació, com per exemple gestió
d'usuaris i permisos, còpies de seguretat, llenguatges estàndards de
consulta, etc.
Tampoc es tenen en compte paràmetres de rendiment; per exemple no es té en compte si hi ha dues subsèries resolució que tenen el mateix pas de consolidació i les funcions d'agregació d'atributs tenen la mateixa funció de representació --per exemple mitjanaZOHE i màximZOHE\todo{símbols}--,   podrien aprofitar la mateixa operació de selecció temporal d'interval ZOHE.



\section{Pytsms}

La biblioteca Pytsms implementa un SGST de referència. Així
doncs, seguint el model, els objectes principals són les mesures, les
sèries temporals i les representacions de les sèries temporals. Tots
tres s'implementen respectivament com a classes \emph{Measure},
\emph{TimeSeries} i \emph{Representation}.


\begin{figure}[tp]
  \centering
  \begin{tikzpicture}

  %Timeseries
  \umlclass[x=0,y=0] {TimeSeries}{}{}  

  % Measure
  \umlclass[x=-4] {Measure}{}{}
  \umluniaggreg[mult=0..*]  {TimeSeries}{Measure}
  \umlclass[x=-5.2,y=-2] {MFloat}{}{}
  \umlclass[x=-2.8,y=-2] {MChar}{}{}
  \umlinherit {MFloat}{Measure}
  \umlinherit {MChar}{Measure}

  %Repr
  \umlclass[x=4] {Representation}{}{} %,type=abstract
  \umlassoc[mult1=1,mult2=1]  {TimeSeries}{Representation}
  \umlclass[x=3,y=-2] {Zohe}{}{}
  \umlclass[x=5,y=-2] {Delta}{}{}
  \umlinherit {Zohe}{Representation}
  \umlinherit {Delta}{Representation}

  %Associacions
  \umlclass[x=-1.5,y=-4] {RegularProp}{}{}
  \umluniassoc  {RegularProp}{TimeSeries}
  \umlclass[x=1.5,y=-4] {Storage}{}{}
  \umluniassoc {Storage}{TimeSeries}

  %Dependencies
  \umlemptypackage[x=5,y=-5]{Matplotlib}
  \umldep{Zohe}{Matplotlib}
  \umldep{Delta}{Matplotlib}


  \end{tikzpicture}



  \caption{Diagrama UML de Pytsms}
  \label{fig:implementacio:pytsms-uml}
\end{figure}





\begin{figure}
  \centering

\begin{tikzpicture}

  %Timeseries
  \umlclass[x=0,y=0] {TimeSeries}{}{}  
  %Realisations 
  \umlclass[x=-3.5,y=-3] {Structure}{}{}
  \umlclass[x=-1.2,y=-3] {OpSet}{}{}
  \umlclass[x=1.2,y=-3] {OpSeq}{}{}
  \umlclass[x=3.5,y=-3] {OpFunc}{}{}
  %\umlreal[geometry=|-|]{Structure}{TimeSeries}
  \umlinherit[geometry=|-|]{TimeSeries}{Structure}
  \umlinherit[geometry=|-|]{TimeSeries}{OpSet}
  \umlinherit[geometry=|-|]{TimeSeries}{OpSeq}
  \umlinherit[geometry=|-|]{TimeSeries}{OpFunc}
  %Subrealisations
  \umlclass[x=-3,y=-6] {SetNoTemporal}{}{}
  \umlclass[x=0.7,y=-6] {SetTemporal}{}{}
  \umlclass[x=4,y=-6] {SetRelacional}{}{}
  \umlinherit[geometry=|-|]{OpSet}{SetNoTemporal}
  \umlinherit[geometry=|-|]{OpSet}{SetTemporal}
  \umlinherit[geometry=|-|]{OpSet}{SetRelacional}
  \umlclass[x=-6,y=-6,type=python] {set}{}{}
  \umlinherit{Structure}{set}

\end{tikzpicture}

  \caption{Diagrama UML de la realització de sèries temporals a Pytsms}
  \label{fig:implementacio:pytsms-uml-ts}
\end{figure}





La \autoref{fig:implementacio:pytsms-uml} mostra amb un diagrama
UML la relació entre aquests tres objectes principals. Així, per una
banda, una \emph{TimeSeries} té una relació d'agregació amb les
\emph{Measure}, és a dir que una sèrie temporal conté cap, una o més
d'una mesura.  Per altra banda, les sèries temporals i les
representacions són ortogonals i això s'implementa mitjançant una
relació d'associació bidireccional entre una \emph{TimeSeries} i una
\emph{Representation}, és a dir que una instància de sèrie temporal té
associada una representació i una instància de representació coneix la
sèrie temporal que representa.




Una \emph{TimeSeries} és un objecte amb una gran quantitat de
mètodes. Com a conseqüència, la implementació de funcionalitats
essencials s'ha dividit en diversos objectes, els quals es mostren a
la \autoref{fig:implementacio:pytsms-uml-ts}. Els mètodes que
implementen el model estructural i el model d'operacions bàsiques
s'han agrupat en objectes segons la seva funcionalitat. Així hi ha
l'objecte \emph{Structure} que implementa el model estructural de les
sèries temporals, l'\emph{OpSet} pel model d'operacions de conjunts,
l'\emph{OpSeq} pel model d'operacions de seqüències i l'\emph{OpFunc}
pel model d'operacions de funció temporal.  Aleshores l'objecte
\emph{TimeSeries} multihereta les funcionalitats d'aquests quatre
objectes, cosa que s'implementa a Python com a
\emph{Mixin} \parencite[\S 8.3.6, \S 20.17]{python:doc2}.  L'objecte
\emph{OpSet} també té una gran quantitat de mètodes i, de la mateixa
manera, hereta la funcionalitat de tres objectes: el
\emph{SetNoTemporal} per a les operacions basades en l'orde parcial de
les sèries temporals, el \emph{SetTemporal} basat en l'ordre temporal
i el \emph{SetRelacional} per a les operacions específiques de
l'àlgebra relacional. Pel que fa a l'\emph{Structure} hereta
funcionalitats dels objectes \emph{set}, que són un tipus predefinit a
Python \parencite[\S 5.7]{python:doc2}.


Les funcionalitats complementàries de les \emph{TimeSeries} s'han
implementat amb relacions d'associació unidireccionals, les quals es
mostren a la \autoref{fig:implementacio:pytsms-uml}. Així, hi ha dues
funcionalitats complementàries: \emph{RegularProperties} és un objecte
que agrupa les operacions relacionades amb la regularitat de les
sèries temporals i \emph{Storage} agrupa les operacions
d'emmagatzematge i de recuperació en fitxers. En aquests casos,
l'associació unidireccional indica que són objectes que treballen
sobre una \emph{TimeSeries} i s'implementa a Python seguint el patró
de disseny
\emph{Visitor} \parencite[cap.~14]{ziade08:expert_python_programming}. Amb
aquest patró les \emph{TimeSeries} esdevenen \emph{Visitable}, és a
dir accepten objectes \emph{Visitor} que aporten funcionalitats
extres. Així doncs, els objectes \emph{RegularProperties} i
\emph{Storage} són \emph{Visitor}.


La \autoref{fig:implementacio:pytsms-uml} mostra exemples
d'especialitzacions de les mesures i de les representacions.
%
Pel que fa a les \emph{Measure}, poden tenir especialitzacions segons
els tipus dels atributs de temps i de valor. Amb aquesta relació
implementem la propietat homogènia de les sèries temporals i la
definició de mesura indefinida i de valor indefinit, és a dir que
totes les mesures que conté una sèrie temporal són del mateix tipus i
cada tipus de mesura té uns valors de l'atribut temps que la
defineixen indefinida i uns valors de l'atribut valor que la
defineixen de valor indefinit.  Així, per defecte, una \emph{Measure}
defineix els reals $-\infty$ i $+\infty$ per a les mesures indefinida
negativa i positiva respectivament, i defineix el valor \emph{None} de
Python per a la mesura de valor indefinit. Aleshores, mitjançant
especialitzacions es poden definir altres tipus de mesures; per
exemple la \emph{MFloat} que defineix el real $\infty$ com a valor
indefinit o bé la \emph{MChar} que defineix mesures de tipus caràcter.




Pel que fa a les representacions, cada representació en concret és una
especialització de \emph{Representation}. Per exemple \emph{Zohe} i
\emph{Delta} implementen la funció de representació ZOHE i la delta
respectivament.
%\emph{Representation} és una classe abstracta?
Bàsicament, cada representació particular ha de definir l'operació que
calcula l'interval temporal i l'operació que permet trobar-ne el graf.
També cadascuna implementa una operació que dibuixi correctament el
gràfic de la sèrie temporal segons la representació; en les
representacions definides s'usa la biblioteca
\emph{Matplotlib} \parencite{python:matplotlib}  per a fer els gràfics.




\subsubsection{Encaix a Python}

\todo{}

Explicar més detalladament quins mètodes tenen les sèries temporals: unió, selecció, etc.

Heretem de sets, implementem els mètodes especials de sets

implementem els mètodes especials de seqüències







\section{RoundRobinson}

La biblioteca RoundRobinson implementa un SGSTM de referència. Així
doncs, seguint el model, els objectes principals són les sèries
temporals multiresolució, les subsèries resolució, els buffers, els
discs i les funcions d'agregació d'atributs. Respectivament
s'implementen com a classes \emph{MultiresolutionSeries},
\emph{Resolution}, \emph{Buffer}, \emph{Disc} i \emph{Function}.
Així, les funcions d'agregació d'atributs són realitzades per
\emph{Function} de Python.


\begin{figure}[tp]
  \centering

\begin{tikzpicture}

  %MultiTimeseries
  \umlclass[x=0,y=0] {MultiresolutionSeries}{}{}  
  \umlclass[x=-4,y=0,type=python] {set}{}{}
  \umlinherit{MultiresolutionSeries}{set}
  %Components 
  \umlclass[x=0,y=-3] {Resolution}{}{}
  \umluniaggreg  {MultiresolutionSeries}{Resolution}
  %SubComponents 
  \umlclass[x=-1.2,y=-6] {Buffer}{}{}
  \umlclass[x=1.2,y=-6] {Disc}{}{}
  \umlclass[x=-3,y=-9,template={s,i},type=interface] {Function}{}{}
  \umlunicompo[mult=1]  {Resolution}{Buffer}
  \umlunicompo[mult=1]  {Resolution}{Disc}
  \umluniassoc[mult=1]  {Buffer}{Function}

  %TimeSeries
  \begin{umlpackage}[x=1,y=-9]{Pytsms}
    \umlclass{TimeSeries}{}{}  
  \end{umlpackage}
  \umluniassoc[mult=1]  {Buffer}{TimeSeries}
  \umluniassoc[mult=1]  {Disc}{TimeSeries}

  %Associacions
  \umlclass[x=4,y=-3] {Storage}{}{}
  \umluniassoc {Storage}{MultiresolutionSeries}
  \umlclass[x=4,y=-1] {Plot}{}{}
  \umluniassoc {Plot}{MultiresolutionSeries}

\end{tikzpicture}

  \caption{Diagrama UML de RoundRobinson}
  \label{fig:implementacio:roundrobinson-uml}
\end{figure}



La \autoref{fig:implementacio:roundrobinson-uml} mostra amb un
diagrama UML la relació entre aquests cinc objectes principals. Així,
una \emph{MultiresolutionSeries} té una relació d'agregació amb les
\emph{Resolution}, és a dir que una sèrie temporal multiresolució
conté subsèries resolucions.  Una \emph{Resolution} té una relació de
composició amb un \emph{Buffer} i una altra amb un \emph{Disc}, és a
dir que cada subsèries resolució està formada exactament per un buffer
i un disc. Cada \emph{Buffer} té una relació d'associació amb una
\emph{TimeSeries}, és a dir amb la sèrie temporal del buffer; de
manera similar per la sèrie temporal del disc cada \emph{Disc}
s'associa a una \emph{TimeSeries}. A més, cada \emph{Buffer} també té
una relació d'associació amb una \emph{Function} que ha de tenir dos
paràmetres: la sèrie temporal (\emph{s}) i l'interval de consolidació
(\emph{i}).




Les \emph{MultiresolutionSeries} tenen funcionalitats complementàries
que s'han implementat amb relacions d'associació
unidireccionals. Així, hi ha dues funcionalitats complementàries:
\emph{Plot} per a les operacions relacionades amb la visualització
gràfica i \emph{Storage} per a operacions d'emmagatzematge i de
recuperació en fitxers.



Les \emph{MultiresolutionSeries} com a conjunts formats per
\emph{Resolution} s'han implementat heretant funcionalitats dels
\emph{Set} de Python.

\todo{}
explicar més detalladament les operacions de les Multiresolution: add, addResolution, consolidation, etc. i sobretot les totalConsult i les discConsult.





\section{Exemples d'ús}


\todo{}


Amb les biblioteques Pytsms i RoundRobinson podem treballar amb les sèries temporals i les sèries temporals multiresolució. 

Un cas d'exemple és demostrar l'equivalència entre l'operació multiresolució dels SGST sobre una sèrie temporal i la sèrie temporal resultant d'una consolidació dels SGSTM. 












%%% Local Variables:
%%% TeX-master: "main"
%%% End: