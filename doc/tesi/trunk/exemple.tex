\chapter{Exemple}
\label{sec:implementacions:exemple}

En aquest capítol mostrem un exemple de base de dades multiresolució
aplicada a una sèrie temporal real amb dades massives.  

\todo{fer intro}
We use Pytsms and
RoundRobinson implementations in order to create a \acro{MTSDB} and
to query it.

També fem servir roundrobindoop i reltsms?

Com que els resultats són
els mateixos per a totes les computacions, primer mostrem els
resultats i després parlem de com s'han computat?

Passos:

\begin{enumerate}
\item Descrivim la sèrie temporal original.
\item Proposem un esquema de multiresolució.
\item Avaluem els resultats de la consolidació de la sèrie temporal
  amb l'esquema proposat.
\item Comparem les diferents implementacions per a computar l'exemple.
\end{enumerate}


En les computacions hem utilitzat els reals estesos,
$\glssymbol{not:Rb}$, com a domini del temps segons l'estàndard d'Hora
Unix (\seeref{sec:sgst:temps}). Això no obstant, per a facilitar-ne la
comprensió, en els exemples mostrem el domini del temps amb el format
de calendari \gls{UTC}.

\todo{ALERTA!ALERTA! s'ha de comprovar que exactament es pintin les dates en UTC, que les conversions de datetime no afegeixen la zona horària!}



\section{Dades}


Les dades provenen d'un sistema de monitoratge de temperatura en una
xarxa de sensors distribuïts \parencite{alippi10}, en aquest cas ens
centrem en les dades d'un sensor.

Les dades es mostren a la \autoref{fig:exemple:original}.  És una
sèrie temporal adquirida durant un període d'un any i mig, des del 29
d'abril del 2010 fins al 18 d'octubre del 2011. En aquest gràfic, la
sèrie temporal es mostra interpolant linealment les mesures, és a dir
amb el mètode de representació \gls{foh}.  
%
En total hi ha $146.709$
mesures emmagatzemades de la temperatura que va adquirir el sensor, en
graus Kelvin (K), cada 2 minuts tot i que de forma irregular.  Tot i
així en el gràfic només mostrem 466 punts, escollits mitjançant una
delmació amb una resolució d'un dia, ja que de totes maneres una
resolució superior és imperceptible.  En el gràfic d'aquesta sèrie
temporal destaquen alguns períodes en què hi manquen dades i alguns en
què hi ha observacions aberrants.


\begin{figure}[tp]
  \centering
  \input{imatges/exemple/isense_original.tex}
  \caption{Sèrie temporal d'un sensor de temperatura}
  \label{fig:exemple:original}
\end{figure}





\section{Esquema de multiresolució}

Dissenyem un esquema de multiresolució per a la sèrie temporal.
Aquest esquema resumeix la sèrie temporal amb més resolució per als
temps recents i amb menys resolució per als temps antics.



El cronograma de l'esquema de multiresolució es mostra a la
\autoref{fig:exemple:cronograma}, en què cada resolució té un color
diferent. Té la mateixa estructura que el cronograma periòdic definit
a la \autoref{fig:model:cronograma-simplificat} però amb els valors
particularitzats per a aquest exemple.  De més a menys resolució,
l'esquema és el següent:



\begin{figure}[tp]
  \centering
  \input{imatges/exemple/mtsdb-time_window.tex}
  \caption{Cronograma de l'esquema de multiresolució}
  \label{fig:exemple:cronograma}
\end{figure}

\begin{enumerate}
\item Es consolida una mesura cada 5 hores en un disc amb capacitat de
  24 mesures. Per tant, en total aquesta resolució emmagatzema
  informació durant 5 dies.

\item Es consolida una mesura cada 2 dies en un disc amb capacitat de
  20 mesures. Per tant, s'emmagatzema durant 40 dies.

\item Es consolida una mesura cada 15 dies en un disc amb capacitat de
  12 mesures.  Per tant, s'emmagatzema durant 180 dies.

\item Es consolida una mesura cada 50 dies en un disc amb capacitat de
  12 mesures.  Per tant, s'emmagatzema durant 600 dies.

\end{enumerate}



Aquest esquema està dissenyat per mostrar diferents paràmetres de la
multiresolució. Així el criteri escollit és el de visualitzar algunes
resolucions de la sèrie temporal original, la qual té un període de
mostreig irregular de 2 minuts, des de la resolució cada 5 hores fins
a la resolució cada 50 dies. També s'ha escollit per a mantenir uns
lapses de temps repartits, des del lapse de 600 dies que emmagatzema
tota la sèrie temporal original fins al de 5 dies que només conté una
informació molt recent.


Com a funció d'agregació d'atributs utilitzem la mitjana de la família
\gls{zohe} (\seeref{def:sgstm:agregadorszohe}) per a totes les
resolucions. A més, per a mostrar diferents maneres d'usar els
agregadors, utilitzem el màxim de la família \gls{zohe} però només per
a les darreres resolucions.


De manera simplificada, iniciem la consolidació de totes les
resolucions al mateix instant de temps, que notem amb $\tau_0$. Com ja
hem dit, les dades originals s'inicien el 29 d'abril del 2010, per
tant un $\tau_0=$ 1 de gener de 2010 és raonable.


Així doncs, l'expressió de l'esquema de multiresolució en termes de la \autoref{def:sgstm:esquema}, i enumerant cada resolució,  és
\begin{align*}
e = \{ &\\ 
&(\delta_1=5 \text{ h},f_1=\glssymbol{not:sgstm:meanzohe},k_1=24,\tau_1=\tau_0),\\
&(\delta_2=2 \text{ d},f_2=\glssymbol{not:sgstm:meanzohe},k_2=20,\tau_2=\tau_0),\\
&(\delta_3=15 \text{ d},f_3=\glssymbol{not:sgstm:meanzohe},k_3=12,\tau_3=\tau_0),\\
&(\delta_4=50 \text{ d},f_4=\glssymbol{not:sgstm:meanzohe},k_4=12,\tau_4=\tau_0),\\
&(\delta_{3b}=15 \text{ d},f_{3b}=\glssymbol{not:sgstm:maxzohe},k_{3b}=12,\tau_{3b}=\tau_0),\\
&(\delta_{4b}=50 \text{ d},f_{4b}=\glssymbol{not:sgstm:maxzohe},k_{4b}=12,\tau_{4b}=\tau_0),\\
\}&
\end{align*}

% \begin{align*}
% e = ( & (\delta,f,k,\tau), \{  \\ 
% &(5 \text{ h},\glssymbol{not:sgstm:meanzohe},24,\tau_0),\\
% &(2 \text{ d},\glssymbol{not:sgstm:meanzohe},20,\tau_0),\\
% &(15 \text{ d},\glssymbol{not:sgstm:meanzohe},12,\tau_0),\\
% &(50 \text{ d},\glssymbol{not:sgstm:meanzohe},12,\tau_0),\\
% &(15 \text{ d},\glssymbol{not:sgstm:maxzohe},12,\tau_0),\\
% &(50 \text{ d},\glssymbol{not:sgstm:maxzohe},12,\tau_0),\\
% \})&
% \end{align*}

Com que els atributs de mitjana i màxim comparteixen les dues darreres
resolucions, les anomenem amb el mateix número però marcant amb una
$b$ les de màxim.  En total, sumant les capacitats de cada disc,
s'emmagatzemen $24+20+12+12+12+12=92$ mesures.




% \todo{podem proposar una altre esquema?}
% * un que dupliqui la capacitat: podríem ampliar la capacitat, del de 600 no perquè ja ho abasta tot però sí dels altres, per exemple per tenir 10 dies de resolució de cada 5 hores. 

% * un que utilitzi les agregacions DD, aleshores aquest té retard de buffer





\section{Resultats de la consolidació}

En un \gls{SGSTM}, consolidem la sèrie temporal original amb l'esquema
de multiresolució proposat. Del resultat, podem fer-ne les dues consultes bàsiques (\seeref{sec:sgstm:consultes}):

\begin{enumerate}
\item Les consultes \glssymbol{not:sgstm:seriedisc} per a obtenir les
  subsèries temporals que han quedat consolidades a cada subsèrie
  resolució.
\item Les consultes \glssymbol{not:sgstm:serietotal} per a obtenir la sèrie
  temporal total per a cada atribut.
\end{enumerate}


En primer lloc, a la \autoref{fig:exemple:4mrd} es mostren totes les
subsèries resolució consolidades. Cada gràfic correspon a una consulta
possible de \glssymbol{not:sgstm:seriedisc}, tot i que les resolucions
que només difereixen en l'atribut es mostren en el mateix gràfic.
Aquest és el cas de les dues darreres resolucions que comparteixen els
mateixos paràmetres llevat de la funció d'agregació d'atributs: en
blau es mostra l'atribut de \glssymbol{not:sgstm:meanzohe} i en
taronja el de \glssymbol{not:sgstm:maxzohe}.  El títol de cada gràfic
indica la subsèrie resolució i els paràmetres de pas de consolidació i
de cardinal màxim.


\begin{figure}[tp]
  \centering
  % \tikzset{
  %   every picture/.style={scale=0.7},
  % }
  \input{imatges/exemple/isense_4mrdb.tex}
  \caption{Subsèries resolució emmagatzemades a la base de dades}
  \label{fig:exemple:4mrd}
\end{figure}

Cada sèrie temporals es mostra amb el mètode de representació
\gls{zohe}, car s'han consolidat amb funcions d'agregació basades en
aquest mètode.  Els eixos de temps marquen els instants de temps però
arrodonits en la forma de calendari, per exemple en el primer gràfic
hi apareixen les hores però en els altres no encara que cada instant
marca una hora concreta.  Els valors aberrants es marquen amb
discontinuïtats en el gràfic, aquest és el cas de l'atribut màxim del
tercer i quart gràfic en què pren un valor de 2938 K.  Pel que va a
les dades que manquen, les funcions d'agregació utilitzades han
omplert els buits. Això és degut que les agregacions utilitzen el
mètode de representació \gls{zohe} i per tant els valors coneguts es
mantenen cap enrere, tot i que més correctament per a aquest cas
s'hauria de limitar la durada que un valor es pot considerar vàlid per
a mantenir-lo o bé s'hauria d'incloure una tècnica de reconstrucció
del senyal en les funcions d'agregació d'atributs.

També es pot mostrar totes les subsèries resolució consolidades en un
mateix gràfic, com a la \autoref{fig:exemple:4mtot} en què cada
resolució té el mateix color que a la
\autoref{fig:exemple:cronograma}. En aquest gràfic es pot observar
clarament quin tros de la sèrie temporal original (en gris) resumeix
cada resolució. Això no obstant, a la \autoref{fig:exemple:4mrd} es
visualitza més bé la informació de cada resolució, sobretot en el cas
de la primera resolució de 5 hores que a la
\autoref{fig:exemple:4mtot} no se'n distingeixen les mesures.

\begin{figure}[tp]
  \centering
  %\tikzset{every picture/.style={scale=0.8}}
  \input{imatges/exemple/isense_4m-all.tex}
  \caption{Comparació de la sèrie temporal original en gris amb les subsèries resolució en els mateixos colors que a la \autoref{fig:exemple:cronograma}}
  \label{fig:exemple:4mtot}
\end{figure}




En segon lloc, a la \autoref{fig:exemple:4mrdtot} es mostra la
consulta de la sèrie temporal total per a l'atribut de
\glssymbol{not:sgstm:meanzohe} (en blau) i per a l'atribut de
\glssymbol{not:sgstm:maxzohe} (en taronja). Ambdues consultes de
$\glssymbol{not:sgstm:serietotal}$ s'han calculat amb concatenació
temporal \gls{zohe} i es representen gràficament  amb el mètode \gls{zohe}. En gris es mostra la sèrie temporal original
amb el mètode de representació \gls{foh}.  Comparant les sèries
temporals consolidades amb l'original, podem observar que la mitjana
s'assembla a un filtre passabaix i el màxim s'assembla a l'envolupant,
tot i que calculats segons els períodes de consolidació que marca
l'esquema de multiresolució. Així, es pot observar que els atributs
tenen una resolució incremental, és a dir menys resolució en els temps
antics i més en els temps recents, i que la mitjana acaba tenint més
resolució que el màxim.


\begin{figure}[tp]
  \centering
  %\tikzset{every picture/.style={scale=0.8}}
  \input{imatges/exemple/isense_mrdb-all.tex}
  \caption{Comparació de la sèrie temporal original amb la sèrie temporal total de la multiresolució per als atributs de mitjana i màxim \gls{zohe}}
  \label{fig:exemple:4mrdtot}
\end{figure}







A tall d'exemple, a la
\autoref{fig:exemple:4mrdtot-foh} es representen els atributs també
amb el mètode \gls{foh}. Com diuen \textcite{keogh97}, aquesta
segmentació de les corbes en línies rectes és més propera a la
suavització que realitza la visió humana.  Això no obstant, les
agregacions estan computades amb \gls{zohe} i per tant la
visualització dels atributs sembla desplaçada temporalment cap a la
dreta. Per tal que quedés més centrat es podria utilitzar una
agregació centrada en l'interval. Tot i així perquè en la
representació \gls{foh} els màxims quedessin a la cresta de
l'envolupant caldria utilitzar una consolidació irregular en què el
temps de les mesures resultants fos el temps en què ocorre el màxim.


\begin{figure}[tp]
  \centering
  %\tikzset{every picture/.style={scale=0.8}}
  \input{imatges/exemple/isense_mrdb-all-foh.tex}
  \caption{Sèries temporals amb mètode de representació \gls{foh}}
  \label{fig:exemple:4mrdtot-foh}
\end{figure}



En conclusió, aquests resultats exemplifiquen com un \gls{SGSTM}
emmagatzema una compressió de les dades originals que conté una certa
informació dels atributs originals. En efecte, les $146.709$ mesures
emmagatzemades originalment es redueixen a $92$ mesures. Aquestes
mesures es reparteixen en diferents resolucions de manera que hi ha
més informació per als temps recents i que cada subsèrie temporal és
regular de període $\delta$. La sèrie temporal total no és regular,
però sí que se'n pot observar una regularitat a trossos ja que és una
concatenació de les subsèries regulars.




\section{Computació}


\todo{revisar} 

En aquests exemple ja es disposa de totes les dades originals
emmagatzemades, per tant la computació és en temps diferit.  Així
doncs, tant podem emmagatzemar la sèrie temporal en un \gls{SGSTM} i
consolidar-lo com calcular la funció de multiresolució de la sèrie
temporal. 


Els resultats són aproximadament els mateixos per a totes les
computacions. Hi ha petites diferències degudes a les diferències
entre les implementacions. Per exemple, a RounRobindoop s'ha hagut
d'aproximar els intervals de consolidació que en el cas \gls{zohe}
s'amplien un interval (\seeref{ex:mapreduce:fzohe}). En aquest
exemple, però, hi ha dades mancants de més d'un interval de durada i
per tant cal utilitzar més d'un interval per a farcir els forats:
RoundRobindoop no té aquesta possibilitat, en canvi RoundRobinson sí.



Hem computat la consolidació amb les tres implementacions de
\gls{SGSTM} dissenyades: RoundRobinson, RoundRobindoop i l'operador
\emph{mtsms.multiresolution} de Reltsms.



Ajustem els taus (v. a \autoref{def:mapreduce:ajustamentdetaus}
No es tenen en compte els cardinals màxims. Si es volen tenir en
  compte, cal adequar bé els $\tau$ inicials.  \autoref{ex:mapreduce:classifica}) s'hauria de dir que hem introduït aquesta funcionalitat a RoundRobinson.



En aquest cas a RoundRobinson podem compartir el buffer físic per a totes les resolucions, perquè treballem en temps diferit (ref a variacions de buffer on es diu la compartició)


En RoundRobinson hi ha moltes capacitats complementàries: emmagatzemar en fitxers, fer gràfics, etc,. A més és molt genèric, molt proper al model, i permet implementar qualsevol esquema de multiresolució.
A més aquí computem en temps diferit, i roundrobinson no ajusta els tau incials (sí! també ho podem fer, potser s'hauria de posar a l'exemple de roundrobinson?) i per tant computar consolidacions que després són eliminades.
Si la computació s'hagués realitzat en línia tal com s'anaven adquirint les dades, roundrobinson hagués sigut més apropiat.


A RounRobindoop va bé per experimentar amb aquest exemple, perquè tenim totes les dades emmagatzemades, de fet són de fa uns anys, i per tant podem computar-ne la multiresolució de forma ràpida.
Cal dir que comparat amb executar-ho en bash



  The purpose
of this example is to show how the multiresolution is computed for a
time series, it has been computed offline as the original data had
already been acquired. However, a \acro{MTSMS} is designed to
consolidate while the original data is being acquired so that the
multiresolution computation spreads along the acquisition and the
computing time becomes less critical.



Temps orientatius, computats en una màquina de sobretaula. 

Temps RoundRobinson

1. 75 minuts (sense ajustar taus)
2. 72 minuts (ajustant taus)
3. 74 minuts (ajustant taus, consolidate a fora, canviant addicio)
4. 51 minuts (canviant mètode add de les TimeSeries amb MeasureTotalEquality)



sobre el mean i el max directe: les funcions de RoundRobinson són calcades a les del model en el fet que es construeixen a partir dels mètodes de representació, amb l'interval temporal, etc.  Si obviem això els agregadors processen més ràpid.


Temps RoundRobindoop bash
1. 69 minuts
2. 70 minuts
3. 73 minuts
4. 1,43 minuts  (provat amb un mean i max directe)
5. 1,48 minuts  (provat amb un mean i max directe)
6. 1,42 minuts  (provat amb un mean i max directe)
7. 1,43 minuts  (provat amb un mean i max directe)


Temps RoundRobindoop Hadoop
1. 63 minuts  (2 map i 3 reduce)
2. 58 minuts  (2 map i 3 reduce, 15m timeout)
3. 74 minuts (2 map i 6 reduce, 15m timeout)
4. 65 minuts (2 map i 10 reduce, 15m timeout)
5. 76 minuts (2 map i 5 reduce, 15m timeout)
6. 58 minuts  (2 map i 3 reduce, 15m timeout)
7. 58 minuts (2 map i 1 reduce, 15m timeout)

8. 1,31 minuts (provat amb un mean i max directe)
9. 1,33 minuts (provat amb un mean i max directe)
10. 1,35 minuts (provat amb un mean i max directe)
11. 1,31 minuts (provat amb un mean i max directe)


\todo{dir que a escriny poden consultar l'exemple?}



%%% Local Variables:
%%% TeX-master: "main"
%%% End:

%  LocalWords:  multiresolució subsèrie subsèries
