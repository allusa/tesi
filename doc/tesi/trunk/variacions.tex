\chapter{Introducció a consideracions sobre el model}




\todo{estructura?}

Potser estructurar aquesta part amb:

1. SGSTM per a dispositius on l'emmagatzematge reduït i afitat és important
2. SGSTM per a emmagatzematges massius on calen consultes i visualitzacions ràpides
3. Qualitat dels SGSTM, teoria de la informació



Per a 2. i 3. ens farà falta raonar sobre un funció de multiresolució que presentem al capítol tal.







\todo{falta raonar sobre variacions importants}


El model de \gls{SGSTM} que hem definit té l'objectiu de ser genèric i senzill, és a dir sense entrar en detalls particulars o en aspectes que potser són útils a la pràctica però que compliquen l'estructura del model.


Particularment, hi ha una generalització en els buffers que a l'hora d'implementar-se pot resultar estranya. És el fet que de forma genèrica hem definit que en els buffers s'acumula tota la sèrie temporal original independentment en cadascun dels buffers. Això és útil en el model perquè permet definir-ho de forma molt abstracta i abastar diferents possibles variacions, però és bo d'explorar aquestes possibles variacions que podrà tenir en les implementacions.

\begin{itemize}
\item La funció d'agregació d'atributs treballa amb orientació a flux

\item Les resolucions estan encadenades

\item S'emmagatzema tota la sèrie temporal original en un \gls{SGST} i el
\gls{SGSTM} treballa sobre aquestes mesures, és a dir que realment els
buffers no les emmagatzemen sinó que seleccionen les que necessiten a
cada moment. En aquest cas pensem en \gls{SGST} d'emmagatzematge
massiu com els descrits a l'\autoref{art:massius}. A
la~\autoref{sec:multiresolucio:dual} explorarem l'estructura i les
aplicacions de sistemes \gls{SGST} i \gls{SGSTM} conjunts.

\end{itemize}

Per altra banda a la~\autoref{sec:multiresolucio:funcio} observarem com els \gls{SGSTM} es poden definir com una funció sobre una sèrie temporal. Aquests casos ja operaran directament sobre un \gls{SGST} amb tota la sèrie temporal emmagatzemada i per tant els buffers no emmagatzemaran temporalment sinó que treballaran sobre mesures ja emmagatzemades. 




\subsubsection{Compartició de buffers}

\todo{on podríem fer aquest comentari?}
Les diferents $f$ amb mateix $\delta$ poden compartir buffer.












\section{Variacions de l'estructura dels SGSTM}


\todo{intro}

Expliquem dues variacions/precisions/reflexions de l'estructura del
model de \gls{SGSTM}.  Són reflexions pensant en la implementació dels
models, és a dir per al nivell físic on no es gaudeixen dels
avantatges abstractes matemàtics del nivell lògic.

\begin{itemize}
\item Les resolucions estan encadenades

\item La funció d'agregació d'atributs treballa amb orientació a flux

\item i també reflexions sobre el rellotge?

\end{itemize}







\subsection{Resolucions encadenades}


Una sèrie temporal multiresolució amb estructura de resolucions
encadenades té la mateixa estructura que la presentada en el model
(\seeref{cap:model:sgstm}) llevat que hi ha buffers que
reben les mesures d'altres discs en comptes de l'entrada comuna de
mesures.  És a dir, que una subsèrie resolució depèn dels valors
consolidats a una altra subsèrie resolució, cosa que anomenen
resolucions encadenades.


La \autoref{fig:sgstm:encadenats} mostra l'arquitectura d'una base de
dades multiresolució ja presentada a la \autoref{fig:model:bdstm} però
ara modificada amb les resolucions encadenades.  En aquest cas, les
mesures del disc de $R_0$ s'utilitzen en altres buffers i les mesures
del buffer de $R_d$ provenen d'un altre disc. En un cas simple de
resolucions encadenades, podem considerar que el buffer d'una
resolució és exactament el disc de l'altra. En un cas més elaborat,
podem considerar que quan el disc d'una resolució descarta una mesura,
s'afegeix al buffer de l'altra.


\begin{figure}[tp]
  \centering
  \input{imatges/multiresolucio/sgstm-encadenada.tex}
  \caption{Arquitectura encadenada d'una base de dades multiresolució}
  \label{fig:sgstm:encadenats}
\end{figure}


Respecte a l'estructura general, l'estructura encadenada restringeix
els passos de consolidació dels buffers i els cardinals màxims dels
discs. Els buffers que depenen d'una altra resolució han de tenir un
pas de consolidació múltiple de l'altra resolució i han de tenir un
període de buffer que estigui inclòs en el lapse de l'altra resolució.
A més les resolucions encadenades també han de ser coherents en la
funció d'agregació d'atributs, la qual pot ser que hagi de ser la
mateixa funció. Les resolucions encadenades requereixen un estudi més
profund que l'estructura general i poden encadenar pèrdues successives
significatives, com per exemple és el cas de calcular la mitjana
successivament que, per no ser associativa, no és el mateix que
calcular-la en dos buffers independents.


L'estructura de resolucions encadenades pot ser útil per a aplicacions
que necessitin distribuir l'emmagatzematge de les sèries temporals
multiresolució.  En l'estructura genèrica del model, cada mesura que
s'insereix a una base de dades ha d'inserir-se a totes les subsèries
resolució, és a dir que en cas d'un emmagatzematge distribuït tota la
sèrie temporal original s'ha de distribuir a cada subsèrie.  En canvi
en l'estructura de resolucions encadenades, la sèrie temporal original
primer es resumeix en una subsèrie resolució i és només aquest resum
el que es distribueix a la següent subsèrie resolució.  D'aquesta
manera l'emmagatzematge de les resolucions queda distribuït en
diferents nodes i a l'hora de respondre a una consulta només cal
recollir les resolucions ja resumides que es necessitin.
\textcite{deligiannakis07} proposen una estratègia similar de
disseminació de la informació per a xarxes de sensors.



%\subsubsection{Estructura d'exemple}


A continuació mostrem, mitjançant un exemple, la variació que comporten
les resolucions encadenades en el model de \gls{SGSTM}.


\begin{example} [Sèrie temporal multiresolució amb resolucions encadenades]
  \label{ex:multiresolucio:encadenada}

  Per a definir una sèrie temporal multiresolució amb resolucions
  encadenades és útil reprendre l'\autoref{ex:model:bdm-vistes} en què
  s'exemplifica una sèrie temporal multiresolució organitzada en
  vistes.

  En aquest cas la relació de sèries temporals i noms
  $M_2^{\text{series}}$ segueix sent la mateixa $M_2^{\text{series}}=
  ((S':\text{nom},S:\text{sèrie temporal}),\{
  (S_{B1},\{(26,0),(29,0)\}), (S_{D1},\{(10,0), (15,0), (20,0),
  (25,0)\}), (S_{D2},\{(10,0), (20,0)\} )\})$ llevat que no hi ha
  $S_{B2}$, i la sèrie temporal multiresolució amb noms com a domini
  dels atributs de sèries temporals $M_2^{\text{noms}}$ també és la
  mateixa $M_2^{\text{noms}}= ((S'_B:\text{nom},S'_D:\text{nom},
  \tau:\glssymbol{not:Rb}, \delta:\glssymbol{not:Rb},
  k:\glssymbol{not:N}, f:\text{funció} ),\{ (S_{B1},S_{D1},25 ,5 ,4
  ,\text{mitjana} ), ( \mathbf{S_{D1}},S_{D2},20 , 10 ,3 ,
  \text{mitjana} ) \})$ excepte que el buffer de la segona resolució
  és el disc de la primera $S_{D1}$, el qual el destaquem en negreta.
  Mostrem $M_2^{\text{series}}$ i $M_2^{\text{noms}}$ en forma de
  taula a la \autoref{fig:multiresolucio:exencadenat}.

  \begin{figure}[tp]
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}
      \multicolumn{2}{c}{$M_2^{\text{noms}}$} \\ \hline
      $S'_B$  & $S'_D$ & $\tau$ & $\delta$ & $k$ & $f$ \\ \hline
      $S_{B1}$ & $S_{D1}$ & 25 & 5  & 4 & mitjana  \\
      $\mathbf{S_{D1}}$ & $S_{D2}$ & 20 & 10 & 3 & mitjana  \\ \hline
    \end{tabular}\qquad
    \begin{tabular}{|c|c|c|}
      \multicolumn{3}{c}{$M_2^{\text{series}}$} \\ \hline
      \multirow{2}{*}{$S'$}  &  \multicolumn{2}{c|}{$S$} \\ \cline{2-3}
      & $t$      & $v$  \\ \hline
      \multirow{2}{*}{$S_{B1}$} 
      & 26 & 0 \\ 
      & 29 & 0 \\ \hline
      \multirow{4}{*}{$S_{D1}$} 
      & 10 & 0 \\ 
      & 15 & 0 \\ 
      & 20 & 0 \\ 
      & 25 & 0 \\ \hline
      \multirow{2}{*}{$S_{D2}$} 
      & 10 & 0 \\ 
      & 20 & 0 \\ \hline
    \end{tabular}
    \caption{Taula d'una sèrie temporal multiresolució amb resolucions encadenades}
    \label{fig:multiresolucio:exencadenat}
  \end{figure}




  \begin{figure}[tp]
    \centering
    \input{imatges/multiresolucio/sgstm-exemple-encadenada.tex}
    \caption{Arquitectura de la base de dades multiresolució
      particular per l'\autoref{ex:multiresolucio:encadenada}}
    \label{fig:multiresolucio:ex-arqu-encadenada}
  \end{figure}



  Se segueix aplicant la mateixa operació de $\text{vista } M_2$ que a
  l'\autoref{ex:model:bdm-vistes} per a obtenir la sèrie temporal
  multiresolució. A la \autoref{fig:multiresolucio:ex-arqu-encadenada}
  particularitzem l'arquitectura de la \autoref{fig:sgstm:encadenats}
  per a la base de dades d'aquest exemple. Cal, però, tenir dues
  consideracions en les operacions estructurals dels \gls{SGSTM} per a
  les resolucions encadenades: 

  \begin{itemize}
  \item L'operació d'inserció de mesures, $\glssymbol{addM}(M,m)$, no
    pot inserir la mesura a tots els buffers de les subsèries
    resolució sinó només a aquells que no estiguin encadenats. En el
    cas de l'exemple només al buffer $B_1$.  Aquests buffers, als
    quals podem anomenar buffers d'entrada, es poden expressar amb
    l'operació $ \glssymbol{not:sgst:project}_{\{S'_B\}}(
    M_2^{\text{noms}} ) -
    \glssymbol{not:sgst:rename}_{S'_D/S'_B}\left(
      \glssymbol{not:sgst:project}_{\{S'_D\}}( M_2^{\text{noms}}
      )\right)$.


  \item Només es poden eliminar les mesures dels buffers que no siguin
    encadenats, és a dir dels buffers d'entrada. Les resolucions
    encadenades només poden llegir les dades dels altres discs però
    no hi tenen control.

  \end{itemize}







\end{example}









\subsection{Funcions d'agregació amb orientació a flux}


Les funcions d'agregació d'atributs definides a
\textref{sec:model:agregador} operen sobre un interval de la sèrie
temporal i retornen una mesura que en resumeix un atribut. Aquesta
definició genèrica implica que els buffers han d'emmagatzemar
temporalment un conjunt de mesures de la sèrie temporal original i un
cop resumides les poden eliminar.

Això no obstant, es poden utilitzar els algoritmes d'orientació a
flux, com els que proposen \textcite{cormode08:pods}, per tal d'afitar
els cardinals dels buffers. Tot i així no totes les funcions
d'agregació d'atributs es poden implementar amb orientació a flux.




Definim una funció d'agregació amb orientació a flux, $f^\text{flux}$,
com aquella que implementa el comportament equivalent a una funció
d'agregació d'atributs $f$. A diferència de les $f$, treballen sobre
dues mesures $m'=f^\text{flux}(m_f,m,i)$ per a retornar la mesura
resultant $m'$, on $m$ és la nova mesura que s'ha d'incorporar al
flux, $m_f$ és el flux anterior ja processat i $i=[t_a,t_b]$ és
l'interval de consolidació de $f$.  Per exemple, redefinim les
funcions d'agregació \gls{dd} màxim i mitjana per tal que tinguin
orientació a flux:

\begin{itemize}
\item $\glssymbol{not:sgstm:maxdd}^\text{flux}: m_f \times m \times i \mapsto
  m'$ on $V(m')=\max(V(m_f),V(m))$ i $T(m')=\frac{t_b+t_a}{2}$. 


\item $\glssymbol{not:sgstm:mitjanadd}^\text{flux}: m_f \times m
  \times i \mapsto m'$ on $V(m') = V(m_f) + \frac{V(m)}{t_b-t_a}$ i
  $T(m')=\frac{t_b+t_a}{2}$.

\end{itemize}


Així, sigui $S=\{m_0,\dotsc,m_k\}$ una sèrie temporal i $i=[t_a,t_b]$
un interval de dos instants de temps, calcular en flux $m'_0 =
\glssymbol{not:sgstm:mitjanadd}^\text{flux}((0,0),m_0,i), m'_1 =
\glssymbol{not:sgstm:mitjanadd}^\text{flux}(m'_0,m_1,i), \dotsc, m'_k
= \glssymbol{not:sgstm:mitjanadd}^\text{flux}(m'_{k-1},m_k,i)$ és
equivalent a $m_k'=\glssymbol{not:sgstm:mitjanadd}(S,i)$, on $(0,0)$
és una mesura inicial per al flux.




Per a utilitzar en els \gls{SGSTM} les funcions d'agregació d'atributs
amb orientació a flux s'han de canviar els operadors d'afegir i de
consolidar dels buffers:



\begin{itemize}
\item Sigui la \autoref{def:sgstm:addB}, se'n modifica el comportament
  perquè $B=(m_B,\tau,\delta,f)$ sigui un buffer que emmagatzema una
  mesura $m_B$ en comptes d'una sèrie temporal i l'operació d'afegir
  sigui $\glssymbol{addB}(B,m)= (m'_B,\tau,\delta,f)$ on $m'_B =
  f^\text{flux}(m_B,m,[\tau,\tau+\delta])$ i $f^\text{flux}$ és una
  funció d'agregació d'atributs orientada a flux.


\item Sigui la \autoref{def:model:consolidacio-buffer}, se'n modifica
  el comportament perquè essent el buffer modificat
  $B=(m_B,\tau,\delta,f)$ l'operació de consolidar sigui
  $\glssymbol{consolidaB}(B) = (B',m_B)$ on
  $B'=(m'_B,\tau+\delta,\delta,f)$ i $m'_B$ ha de ser l'element
  d'identitat de $f^\text{flux}$. Per exemple $m'_B=(0,0)$ per a l'atribut
  de mitjana i $m'_B=(0,\min(\glssymbol{not:valor-domini}))$ per a
  l'atribut de màxim on $\glssymbol{not:valor-domini}$ és el domini
  dels valors. 

\end{itemize}

Així doncs, en l'orientació a flux de les funcions d'agregació
d'atributs, la mesura resultant es computa durant l'operació d'afegir
noves mesures al buffer i quan s'ha de consolidar el buffer el
resultat ja està disponible, només cal determinar l'element que actua
com a identitat per a la funció d'agregació amb flux.  En aquest cas,
no té sentit parlar de l'eliminació de mesures antigues en el buffer.









\subsubsection{Push i pull}

Estudiar Push o pull aplicada als SGSTM i quines implicacions pot tenir.


\subsubsection{Rellotge}


\todo{atenció que no s'ha parlat enlloc del rellotge en els SGBDM? s'hauria de dir que en principi no es diu res sobre el rellotge i que si segueix l'esquema de consolidació proposat les mateixes mesures van entrant ordenades i van marcant el pas del temps}


\todo{alerta! el model sgstm s'ha fet pensant en els instants de consolidació periòdics. Què passa quan no ho són? }
per exemple event trigerred (només emmatgatzemem informació quan creiem que és interessant). Aleshores potser són casos molt especials i no es pot dibuixar l'esquema? Potser posar tot això com a comentari a la secció d'Altres Estructures: En el model de \gls{SGSTM} s'ha considerat que la consolidació es feia periòdicament però es podria fer quan es cregués oportú, aleshores no es pot preveure quin esquema de multiresolució hi haurà; són casos que requereixen un estudi més profund. Etc. \todo{potser cap a treball futur?}


Parlar de com ha de ser el rellotge en un SGSTM. Pot ser:

* intern (pull): el SGSTM té un rellotge que li va marcant cada quan consolidar; per tant és ell que va decidint quines mesures s'agafaven i quines no i com. En diem de tipus pull perquè d'alguna forma és el SGSTM qui tiba les mesures; en aquest cas fins i tot es podrien contemplar escenaris a on el SGSTM reclamés mesures quan li semblés que no disposa de prou informació.

* extern (push): el SGSTM no té rellotge sinó que les mesures que entren ja tenen un temps i s'assumeix que entren ordenades en el temps; aleshores d'aquesta entrada de mesures s'extreu el rellotge; és a dir que es van sabent els instants de consolidació a partir de les mesures. Això pot provocar un cert decalatge del temps del SGSTM amb el del rellotge real; ja que el primer només canvia quan té mesures noves. En diem de tipus push perquè les mesures són les que controlen el procés (bé el sistema de monitoratge extern). 

* discret: tipus la cpu marca el rellotge; en aquest cas no hi ha un rellotge real sinó que es compten esdeveniments i el rellotge es crea relativament a aquest comptatge. Per exemple és el cas de sistemes encapsulats a on no hi ha RTC i el clock diu cada quan s'ha de consolidar (en aquest moment es consoliden les mesures de què es disposi, les quals potser tampoc tenen temps i per tant el rellotge del SGSTM serà relatiu) o bé un altre exemple és quan la consolidació d'una subsèrie resolució depèn d'una altra subsèrie (p.ex. es consolida cada cop que l'altre ha expulsat quatre mesures).



EL rellotge de consolidació també pot anar en funció de la quantitat de mesures emmagatzemades al buffer.  Per exemple, en el cas de resolucions encadenades, la consolidació pot dependre de tantes mesures consolidades a un altre disc.



\todo{}
* orientat a esdeveniments (event triggered)
* amb rellotge (time triggered)

* en cas de comptadors digitals, aquests cada cop que incrementen el valor poden fer un push a la base de dades. En comptadors analògics no ho poden fer perquè van incrementant contínuament i no discretament.






\subsubsection{RRDtool}

\todo{rrdtool?}
Dibuixar l'esquema bàsic de RRDtool i comentar-lo aquí?






%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "main"
%%% End: 





