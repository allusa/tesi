\section{Model d'operacions}

En aquesta secció es defineixen els operadors que permeten modelar el
comportament i la manipulació de les dades en el model de SGSTM.

Per a treballar amb les sèries temporals multiresolució s'utilitzen
els conceptes descrits al model d'operacions de SGST. El model de
SGSTM es defineix a partir del model de SGST i per tant les operacions
dels SGSTM també hi estan basades. Tot i així cal tenir en compte dues
particularitats.

Per una banda, el model de SGSTM treballa amb sèries temporals
multiresolució. Així, es defineixen operadors que permeten extreure
les sèries temporals emmagatzemades en aquestes bases de dades amb
l'objectiu d'aplicar-hi posteriorment els operadors dels SGST.

Per altra banda, el model de SGSTM té una estructura específica que
requereix ser manipulada coherentment. Així, es defineixen operadors
que saben treballar amb aquesta estructura agrupats en dos grups.  El
primer grup són els operadors requerits pel model estructural;
operadors que són inseparables de l'estructura i són utilitzats en el
procés d'emmagatzemar les mesures. El segon grup són els operadors
necessaris per a manipular l'estructura; és a dir operadors que
permeten fer canvis en l'esquema de la base de dades o consultar
paràmetres de l'esquema actual.


En el disseny del model d'operacions següent es distingeixen tres
grups d'operadors segons els casos anteriors:

\begin{itemize}
\item Estructurals: operadors requerits pel model estructural.
\item Manipulació: operadors per a manipular l'esquema de multiresolució.
\item Consultes: operadors per a extreure les sèries temporals.
  emmagatzemades
\end{itemize}





\subsection{Estructurals}
\label{sec:model:sgstm-estructurals}

En el model estructural de SGSTM hem definit les sèries temporals
multiresolució com un conjunt de subsèries resolució a les quals es
van afegint mesures compactant-les i consolidant-les. En aquest
apartat definim els operadors que permeten inserir mesures noves i
consolidar-les al seu lloc corresponent en l'estructura.

A continuació es descriuen els operadors associats a cada objecte del
model de SGSTM.


\subsubsection{Buffer}

Els buffers reben les noves mesures i les consoliden a cada instant de
consolidació. Així, tenen dos operadors associats: un per afegir noves
mesures al buffer i un altre per consolidar-les.


L'operació d'afegir una mesura al buffer consisteix en afegir-la a la
sèrie temporal pendent de consolidar.
\begin{definition}[Afegeix mesura al buffer]
  Sigui $B=(S,\tau,\delta,f)$ un buffer i $m=(t,v)$ una mesura, la
  inserció de la mesura al buffer $\addB(B,m)$ és un buffer
  $B'=(S',\tau,\delta,f)$ amb la mesura afegida a la sèrie temporal
  del buffer: $\addB(B,m) = (S',\tau,\delta,f)$ a on $S'=S\cup \{m\}$.
\end{definition}


L'operació de consolidació d'un buffer consisteix en compactar les
mesures segons els intervals de consolidació i la funció d'agregació i
a suprimir la part ja consolidada de la sèrie temporal.  Així doncs,
la consolidació d'un buffer per cada interval de temps
$i=[\tau,\tau+\delta]$ dóna com a resultat una mesura calculada en
funció de l'agregador d'atributs i un nou buffer amb la sèrie temporal
reduïda.
\begin{definition}[Consolida el buffer]
  Sigui $B=(S,\tau,\delta,f)$ un buffer, la consolidació del buffer
  $\consB(B,m)$ en l'interval de temps $[\tau,\tau+\delta]$ és un
  buffer $B'=(S',\tau',\delta,f)$, amb el nou instant de consolidació,
  i la mesura $m'=(t',v')$ resultant de la consolidació: $\consB(B) =
  (S',\tau+\delta',\delta,f) \times m'$ a on
  $m'=f(S,[\tau,\tau+\delta])$ i $S'$ és el resultat d'eliminar les
  dades històriques que no es necessiten més. 

  \emph{Nota}: En el model teòric es pot donar $S'=S$ tot i que a les
  implementacions normalment caldrà eliminar les dades ja no
  necessàries per no ocupar espai amb per exemple $S'=
  S[\tau+\delta,+\infty]$.
\end{definition}

De manera simplificada, hem definit que cada consolidació només
s'aplica a l'interval de consolidació actual; així la consolidació
total del buffer és l'aplicació successiva de l'operació de
consolidació.

Aquesta consolidació successiva requereix que les mesures s'insereixen
al buffer ordenades en el temps, sinó un cop duta a terme la
consolidació les mesures inserides desordenades poden no ser tingudes
en compte. Si es duu a terme aquesta inserció ordenada, aleshores un
buffer té l'estat de consolidable quan el temps d'una mesura de la
sèrie temporal és més gran que el següent instant de temps de
consolidació del buffer.
\begin{definition}[Buffer consolidable]\label{def:model:buffer_consolidable}
  Sigui $B=(S,\tau,\delta,f)$ un buffer, definim que $B$ és
  consolidable si i només si $T(m) \geq \tau+\delta$ a on $m=\sup(S)$
  és la mesura suprema de la sèrie temporal del buffer.
\end{definition}



\subsubsection{Disc}

Els discs reben les mesures consolidades per a emmagatzemar-les de
forma acotada. Així, tenen un operador associat que afegeix noves
mesures al disc mantenint sota control el seu cardinal.


L'operació d'afegir una mesura al disc consisteix en afegir-la a la
sèrie temporal i a eliminar la mesura mínima d'aquesta si se supera el
cardinal permès.
\begin{definition}[Afegeix mesura al disc]
  Sigui $D=(S,k)$ un disc i $m=(t,v)$ una mesura, la inserció de la
  mesura al disc $\addD(D,m)$ és un disc $D'=(S',k)$ amb la mesura
  afegida a la sèrie temporal del disc mantenint el cardinal màxim:
  $\addD(S,m) = (S',k)$ a on $S'=
  \begin{cases}
      S\cup\{m\} &\text{si }  |S|<k\\
      (S-\{\min(S)\}) \cup \{m\} &\text{altrament}
    \end{cases}$.
\end{definition}




\subsubsection{Subsèrie resolució}

Les subsèries resolució són l'aparellament d'un buffer amb un disc.
Així tenen dos operadors associats, els quals treballen amb els
operadors del buffer i del disc : un per afegir una mesura al buffer i
un altre per consolidar el buffer i afegir la mesura resultant al disc


L'operació d'afegir una mesura a la subsèrie resolució consisteix en
afegir-la al buffer.
\begin{definition}[Afegeix mesura a la subsèrie resolució]
  Sigui $R=(B,D)$ una subsèrie resolució i $m=(t,v)$ una mesura, la
  inserció de la mesura a la subsèrie resolució $\addR(R,m)$ és una
  subsèrie resolució $R'=(B',D)$ amb la mesura afegida al buffer:
  $\addR(R,m) = (B',D)$ a on $B'=\addB=(B,m)$.
\end{definition}


L'operació de consolidar una subsèrie resolució consisteix en calcular
una mesura de consolidació del buffer, en l'interval de consolidació
actual, i desar-la al disc. Una subsèrie resolució és consolidable
quan ho és el seu buffer.
\begin{definition}[Consolida la subsèrie resolució]
  Sigui $R=(B,D)$ una subsèrie resolució, la consolidació de la
  subsèrie resolució $\consR(R)$ és una subsèrie resolució
  $R'=(B',D')$ \todo{}
\end{definition}



% (ii) The consolidation of the resolution disc by consoli-
% dating its buffer and adding the consolidation measure
% to its disc, consolidateRD : R = (B, D) → R where
% R = (B , D ) and (B , m ) = consolidateBuffer(B) and
% D = addDisc(B, m ).


\begin{definition}
  L'operació \emph{consolida} calcula una  mesura de consolidació del buffer, en
  l'interval de consolidació actual, i la desa al disc. 
  \[
  \text{consolida}: \text{Disc Round Robin} \longrightarrow \text{Disc Round Robin}
  \]
  \[
  R=(B,D) \longrightarrow R'= (B',D')
  \]
  \[
  B' \times m'= \text{ consolida } B 
  \]
  \[
  D'= D \text{ afegeix } m'
  \]
\end{definition}





\subsubsection{Base de dades multiresolució}



With reference to the operators, the add and consolidate in a multiresolution database are applied to every resolution disc it contains.


\begin{definition}
  Operator \emph{add} adds a measure to every resolution disc:
  \[
  \text{add}: \text{multiresolution database} \times \text{Measure}
  \longrightarrow \text{multiresolution database}
  \]
  \[
  M=\{R_0,\dotsc,R_d\} \times m \mapsto M' 
  \]
  \[  
  M'= \{ \forall R_i\in M: R_i \text{ add } m \}
  \]
\end{definition}


\begin{definition}
  Operator \emph{consolidate} consolidates the resolution discs that
  are ready to consolidate.
  \[
  \text{consolidate}: \text{multiresolution database} \longrightarrow
  \text{multiresolution database}
  \]
  \[
  M=\{R_0,\dotsc,R_d\} \mapsto M'
  \]
  \[
  M'= \big\{
  \forall R_i\in M: 
  \begin{cases}
    \text{ consolidate } R_i & \text{if } R_i \text{ ready to consolidate} \\
    R_i & \text{else }
  \end{cases}\big\}
  \]
\end{definition}







\subsection{Manipulació}

* Fusió d'esquemes de BDM

* Canvis d'esquemes de BDM (afegir multivaluat, canvi de delta d'un disc,canvi de la k,...)

* Estudiar Push o pull










\subsubsection{Estudis en l'esquema}

Quin és el període de la sèrie temporal d'un disc?
  \begin{gather*}
    \text{periodeR}: R \longrightarrow \delta':\\
    \delta'=
    \begin{cases}
      \delta_r &\text{si } S_D \text{ regular o temps real amb } \delta_r\\
      \delta &\text{altrament}
    \end{cases}
  \end{gather*}
  
Quin és el l'interval temporal de la sèrie temporal d'un disc?
  \begin{gather*}
    \text{intervalR}: R \longrightarrow [T_0,T_f] :\\
    T_0 = T(\min(S_D)),     T_f = T(\max(S_D))
  \end{gather*}

Quin és el lapse temporal d'un disc?
  \begin{gather*}
    \text{lapseR}: R \longrightarrow [T_0,T_f] :\\
    T_0 = \tau - k\delta,  T_f = \tau
  \end{gather*}

Quina és la durada del lapse temporal d'un disc?
  \begin{gather*}
    \text{duradaR}: R \longrightarrow k\delta
  \end{gather*}

Nota sobre lapse i durada, donat un disc resolució la durada sempre és fixa i el lapse que cobreix té una certa variació que es correspon a $t_{actual}-\tau$.

De fet sigui $[T_0,T_f] = lapseR(R)$ la  $\text{duradaR}\equiv T_f -T_0$
\[
    [T_0,T_f] = lapseR(R): T_f = \tau, T_0 = \tau - k\delta,: T_f-T_0 =\tau -( \tau - k\delta) =  k\delta \equiv \text{duradaR}
\]

Així doncs podem dir que un disc resolució ens cobreix un span temporal de  $\text{duradaR}(R)$. Es posiciona absolutament des de $\tau$ enrere. Això vol dir que tindrem un temps recent no cobert de $t_{actual}-\tau$, el qual habitualment com a màxim serà de $\delta$ ($t_{actual}-\tau \leq \delta$) i com a mínim de zero si consolidem la multiresolució periòdicament.




Quin disc conté més resolució?
  \begin{gather*}
    \text{maxR}: R_1 \times R_2 \longrightarrow R_i' | d_i = \max(d_1,d_2) : \\
    d_1 = periodeR(R_1), d_2 = periodeR(R_1)
  \end{gather*}
  





\subsubsection{Canvis en l'esquema d'un disc resolució}


Redueix o augmenta la mida d'un disc
  \begin{gather*}
    \text{CanviaK}: R \times k' \longrightarrow R': \\
    R' = (S_B,S'_D,\delta,\tau,k',f) : \\
    k_d = |S_D|:\\
    S'_D = \begin{cases}
      S_D         & \text{si } k' \geq k_d   \\
      treuN(S_D,k_d-k')    & \text{altrament}
    \end{cases}, \\
    treuN: S \times n \mapsto S'=  
    \begin{cases}
      S                & \text{si } n=0   \\
      treuN(S - \{\min(S)\},n-1)  & \text{altrament}
    \end{cases}
\end{gather*}


Redueix o augmenta el pas de consolidació d'un disc (sense canviar la sèrie temporal emmagatzemada; ja s'anirà canviant quan es consolidin noves mesures)
  \begin{gather*}
    \text{Canvia}\delta: R \times \delta' \longrightarrow R': \\
    R' = (S_B,S_D,\delta',\tau,k,f)
  \end{gather*}


Redueix o augmenta alhora el pas de consolidació i la mida d'un disc
  \begin{gather*}
    \text{CanviaK}\delta: R \times k' \times \delta' \longrightarrow R': \\
    R' = (S_B,S_D',\delta',\tau,k',f): \\    
    t = \{ \tau-n\delta' | n\in\mathbb{N},n<k' \} \\
    S_D' = \text{seleccioResolucio}(S_D,t)
  \end{gather*}




Afegeix un multivalor per a emmagatzemar sèries temporals multivaluades
  \begin{gather*}
    \text{afegeixMultivalor}: R \longrightarrow R': \\
    R' = (S'_{B},S'_{D},\delta,\tau,k,f): \\
    S'_{B} = \text{map}(S_B,(t,v)\mapsto(t,v,\infty)), \\
    S'_{D} = \text{map}(S_D,(t,v)\mapsto(t,v,\infty))
  \end{gather*}\todo{s'ha de fer amb extends i les v han de poder tenir nom}




\subsubsection{Canvis en l'esquema d'una sèrie temporal multiresolució}

Aplicació de map a una BDM.
\begin{gather*}
  \text{map}: M \times f \longrightarrow M' = \{ f(R_0), \dotsc, f(R_k) \} :\\
   \text{a on } f: R_a \mapsto R'
 \end{gather*}
 
Aplicació de fold a una BDM
\begin{gather*}
  \text{fold}: M \times M_i \times f \longrightarrow M' :\\
  = f(\dots(f(f(f(M_i,R_0),R_1),R_2)\dots),R_k), \\
   \text{a on } f: M_a \times R_b \mapsto M'
\end{gather*}





\subsubsection{Treball amb dues BDM}


\paragraph{Unió de multiresolució}

Cas típic:
Mesuro una sèrie temporal. Durant un temps emmagatzemo valors a una
base de dades i després els emmagatzemo a una altra base de dades. Al final vull unir les dues bases de dades.


Unió de dos discs resolució que tenen el mateix $\delta$ i $f$ és un
disc resolució que conté la unió de les sèries de cada un.  Sigui
$R_1^*=(S_{B1},S_{D1},\delta,\tau_1,k_1,f)$ i
$R_2^*=(S_{B2},S_{D2},\delta,\tau_2,k_2,f)$
  \begin{gather*}
    \text{unioR}: R_1^* \times R_2^* \longrightarrow R': \\
    R' = (S'_B,S'_D,\delta,\max(\tau_1,\tau_2),k_1+k_2,f), \\
    S_{Di}, S_{Dj} | R_i = \text{maxR}(R_1,R_2), j \neq i:  \\
    S'_B = \text{unio}(S_{B1},S_{B2})\\
    S'_D = \text{unio}^r(S_{Di},S_{Dj})
\end{gather*}

També es pot unir dos discs resolució amb diferent $\delta$ i $f$,
però llavors s'ha de determinar quins són els $\delta'$ i $f'$
resultants.


Com a relacions multiresolució, dues bases de dades multiresolució es
poden unir si no intersecten en les claus $(\delta,f)$.  En cas que
intersectin, podem definir la unió multiresolució com la unió que sap unir els discs resolució repetits.

\begin{gather*}
    \text{UnioM}: M_1 \times M_2 \longrightarrow M': \\
    K_1 = \{(delta_1,f_1) \in M_1\},K_2 = \{(delta_2,f_2) \in M_2\}, \\
    K_a = K_1 \cap K_2, K_u =  (K_1 \cup K_2) - K_a : \\
    M_{u1}'= seleccio(M_1, (delta,f) \in K_u)\\
    M_{u2}'= seleccio(M_2, (delta,f) \in K_u)\\
    M_a = \{\forall R_1\in M_1,R_2\in M_2: unioR(R_1,R_2) |
       (delta_1,f_1) = (delta_2,f_2) \} \\
    M' =  M_{a} \cup  M'_{1}  \cup  M'_{2}     
\end{gather*}






\paragraph{Fusió de multiresolució}

Tinc una sèrie temporal en una base de dades, i una altra sèrie temporal en una altra base de dades. Vull emmagatzemar-les totes dues en una mateixa base de dades amb una sèrie temporal multivaluada.


Fusió de dos discs resolució que tenen el mateix $\delta$ i $f$.
Sigui $R_1^*=(S_{B1},S_{D1},\delta,\tau_1,k_1,f)$ i
$R_2^*=(S_{B2},S_{D2},\delta,\tau_2,k_2,f)$
  \begin{gather*}
    \text{FusioR}: R_1^* \times R_2^* \longrightarrow R': \\
    R' = (S'_B,S'_D,\delta,\max(\tau_1,\tau_2),k_1+k_2,f), \\
    S'_B = \text{fusio}^r(S_{B1},S_{B2})\\
    S'_D = \text{fusio}^r(S_{D1},S_{D2})
\end{gather*}


Fusió de dues bases de dades multiresolució
\begin{gather*}
    \text{FusioM}: M_1 \times M_2 \longrightarrow M': \\
    K_1 = \{(delta_1,f_1) \in M_1\},K_2 = \{(delta_2,f_2) \in M_2\}, \\
    K_a = K_1 \cap K_2, K_u =  (K_1 \cup K_2) - K_a : \\
    M_{u1} =\text{afegeixMultivalor}(seleccio(M_1, (delta,f) \in K_u))\\
    M_{u2} =\text{afegeixMultivalor}^{v0} (seleccio(M_2, (delta,f) \in K_u))\\
    M_1 = seleccio(M_1, (delta,f) \in K_f) \\
    M_2 = seleccio(M_2, (delta,f) \in K_f) \\
    M_a = \{\forall R_1\in M_1,R_2\in M_2: fusioR(R_1,R_2) |
       (delta_1,f_1) = (delta_2,f_2) \} \\
    M' =  M_{a} \cup  M_{u1}  \cup  M_{u2}     
\end{gather*}






\subsection{Consultes}



Operadors per fer consultes sobre una base de dades multiresolució. 

Mostrar com s'utilitzen els operadors dels SGST quan tenim multiresolució.


* Abans de fer una consulta temporal pot fer falta fer una selecció dels discs resolució amb el mateix interpolador.

* Fer una unió temporal de tots els discs de la BDM i treballar sobre aquest senyal $\longrightarrow$ Abstracció d'una BDSTM com a sèrie temporal; és possible treballar amb una BDSTM com si fos una sèrie temporal?

  - Com a consulta total: $\text{SerieTotal}(M)$

  - Com a consulta amb informació multiresolució: $\text{DiscSelecció}(M,\delta,f)$

* Pensar com operar (per exemple sumar) amb sèries temporals de diferents BDM. 




\subsubsection{Selecció de disc}


Consulta la subsèrie de la BDSTM que té una resolució i atribut
determinat. 


\begin{definition}[DiscSelecció]
  \begin{gather*}
    \text{DiscSelecció}: M \times \delta \times f \longrightarrow S' = S_D: \\
    (S_B,S_D,\delta,\tau,k,f) \in M
\end{gather*}
\end{definition}



\subsubsection{Sèrie temporal total}



\begin{definition}[Sèrie temporal total]
  Sigui $M^*$ una base de dades multiresolució a on no hi ha $\delta$ repetits
  \begin{gather*}
    \text{SerieTotal}: M^* \longrightarrow S': \\
    \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
    \delta_0 < \delta_1 < \delta_2 < \dots < \delta_d : \\
    S' = S_{D0} || S_{D1} || S_{D2} || \dotsb || S_{Dd}
\end{gather*}
\end{definition}

Prèviament es pot fer una selecció dels discs resolució que
comparteixin un determinat agregador d'atributs. \todo{També hi podria
  haver una operació estructural que sabés fusionar dos discs
  resolució}



L'operació de consulta de la sèrie temporal total també es pot aplicar
tenint en compte la representació.
\begin{definition}[Sèrie total amb representació]
  Sigui $M^*$ una base de dades multiresolució a on no hi ha $\delta$
  repetits i $r$ una representació
  \begin{gather*}
    \text{SerieTotal}: M^* \times r \longrightarrow S': \\
    \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
    \delta_0 < \delta_1 < \delta_2 < \dots < \delta_d : \\
    S' = S_{D0} \cup^r S_{D1} \cup^r  S_{D2}  \cup^r \dotsb \cup^r  S_{Dd}
\end{gather*}
\end{definition}



\paragraph{Selecció de resolució}


Per a extreure una resolució determinada de la sèrie temporal
emmagatzemada a la base de dades multiresolució, es consulta la sèrie
temporal total i s'aplica una selecció de resolució
$\text{SerieTotal}(M)[i]^r$ a on $i$ és el conjunt d'instants de
temps.






\subsection{Com treure profit de les operacions dels SGSTM}

Temes que després es poden aprofitar a les implementacions

* No hi ha updates --> les sèries temporals no s'han de canviar

* Per exemple, vull calcular la mitjana de  BDSTM(a,b] si tinc un disc resolució amb $\delta=b-a$ i $f=$mitjana aquest seria l'adequat en comptes de calcular mitjana(SerieTotal(M)(a,b])

%??
% No obstant, la base de dades multiresolució conté informació sobre la
% resolució de les subsèries i per tant aquesta operació és susceptible
% d'implementar-se aprofitant aquesta informació.  A tall d'exemple es
% defineix una operació per extreure de la base de dades multiresolució
% una sèrie temporal regular amb període $T$:


% \begin{definition}[Selecció de resolució regular]
%   \begin{gather*}
%     \text{ResolucióRegular}: M^* \times T \times r \longrightarrow S'\\
%     \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
%     d_i = T - \delta_i , \\
%     0 \geq d_0 > d_1 \dots > d_a, 0 < d_{a+1} < \dots < d_d: \\
%     S'' = S_{D0} || S_{D1} || \dotsb || S_{Da}  ||  S_{Da+1} || \dotsb || S_{Dd}, \\
%     S' = S''[i]^r: i = {t|0+nT,n\in\mathbb{N}}
%   \end{gather*}
% \end{definition}

% Nota: les operacions no són equivalents, l'operació $\text{SerieTotal}(M)[i]^r$ és molt més potent que la $\text{ResolucióRegular}(M,T)$.




\subsection{Comparació d'operacions dels SGSTM amb les dels SGST}

Tinc una sèries temporal $S$ i l'emmagatzemo a una base de dades multiresolució $M$ amb atributs de mitjana. 

* mitjana(S) = mitjana(serieTotal(M)) ?

* Operació O, afegeix(M',O(S)) = O(serieTotal(M))?


\begin{align*}
s   \qquad   &  s'=ST(M(s))\\
r=O(s) \qquad& r'=O(s') \\
\epsilon(r,r')?
\end{align*}

on $O$ és una consulta, per exemple pot ser O=Creix la sèrie temporal? Si la resposta és Sí en els dos casos, aleshores no hi ha error.





%%% Local Variables:
%%% TeX-master: "main"
%%% End:
% LocalWords:  SGSTM l'agregador buffer
