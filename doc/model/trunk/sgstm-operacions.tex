\section{Model d'operacions}

En aquesta secció es defineixen els operadors que permeten modelar el
comportament i la manipulació de les dades en el model de SGSTM.

Per a treballar amb les sèries temporals multiresolució s'utilitzen
els conceptes descrits al model d'operacions de SGST. El model de
SGSTM es defineix a partir del model de SGST i per tant les operacions
dels SGSTM també hi estan basades. Tot i així cal tenir en compte dues
particularitats.

Per una banda, el model de SGSTM treballa amb sèries temporals
multiresolució. Així, es defineixen operadors que permeten extreure
les sèries temporals emmagatzemades en aquestes bases de dades amb
l'objectiu d'aplicar-hi posteriorment els operadors dels SGST.

Per altra banda, el model de SGSTM té una estructura específica que
requereix ser manipulada coherentment. Així, es defineixen operadors
que saben treballar amb aquesta estructura agrupats en dos grups.  El
primer grup són els operadors requerits pel model estructural;
operadors que són inseparables de l'estructura i són utilitzats en el
procés d'emmagatzemar les mesures. El segon grup són els operadors
necessaris per a manipular l'estructura; és a dir operadors que
permeten fer canvis en l'esquema de la base de dades o consultar
paràmetres de l'esquema actual.


En el disseny del model d'operacions següent es distingeixen tres
grups d'operadors segons els casos anteriors:

\begin{itemize}
\item Estructurals: operadors requerits pel model estructural.
\item Manipulació de l'esquema: operadors per a manipular l'esquema de
  multiresolució.
\item Consultes: operadors per a extreure les sèries temporals
  emmagatzemades.
\end{itemize}





\subsection{Estructurals}
\label{sec:model:sgstm-estructurals}

En el model estructural de SGSTM hem definit les sèries temporals
multiresolució com un conjunt de subsèries resolució a les quals es
van afegint mesures compactant-les i consolidant-les. En aquest
apartat definim els operadors que permeten inserir mesures noves i
consolidar-les al seu lloc corresponent en l'estructura.

A continuació es descriuen els operadors associats a cada objecte del
model de SGSTM.


\subsubsection{Buffer}

Els buffers reben les noves mesures i les consoliden a cada instant de
consolidació. Així, tenen dos operadors associats: un per afegir noves
mesures al buffer i un altre per consolidar-les.


L'operació d'afegir una mesura al buffer consisteix en afegir-la a la
sèrie temporal pendent de consolidar.
\begin{definition}[Afegeix mesura al buffer]
  Sigui $B=(S,\tau,\delta,f)$ un buffer i $m=(t,v)$ una mesura, la
  inserció de la mesura al buffer $\addB(B,m)$ és un buffer
  $B'=(S',\tau,\delta,f)$ amb la mesura afegida a la sèrie temporal
  del buffer: $\addB(B,m) = (S',\tau,\delta,f)$ a on $S'=S\cup \{m\}$.
\end{definition}


L'operació de consolidació d'un buffer consisteix en compactar les
mesures segons els intervals de consolidació i la funció d'agregació i
a suprimir la part ja consolidada de la sèrie temporal.  Així doncs,
la consolidació d'un buffer per cada interval de temps
$i=[\tau,\tau+\delta]$ dóna com a resultat una mesura calculada en
funció de l'agregador d'atributs i un nou buffer amb la sèrie temporal
reduïda.
\begin{definition}[Consolida el buffer]
  Sigui $B=(S,\tau,\delta,f)$ un buffer, la consolidació del buffer
  $\consB(B)$ en l'interval de temps $[\tau,\tau+\delta]$ és un
  buffer $B'=(S',\tau',\delta,f)$, amb el nou instant de consolidació,
  i la mesura $m'=(t',v')$ resultant de la consolidació: $\consB(B) =
  (S',\tau+\delta',\delta,f) \times m'$ a on
  $m'=f(S,[\tau,\tau+\delta])$ i $S'$ és el resultat d'eliminar les
  dades històriques que no es necessiten més. 

  \emph{Nota}: En el model teòric es pot donar $S'=S$ tot i que a les
  implementacions normalment caldrà eliminar les dades ja no
  necessàries per no ocupar espai amb per exemple $S'=
  S[\tau+\delta,+\infty]$.
\end{definition}

De manera simplificada, hem definit que cada consolidació només
s'aplica a l'interval de consolidació actual; així la consolidació
total del buffer és l'aplicació successiva de l'operació de
consolidació.

Aquesta consolidació successiva requereix que les mesures s'insereixen
al buffer ordenades en el temps, sinó un cop duta a terme la
consolidació les mesures inserides desordenades poden no ser tingudes
en compte. Si es duu a terme aquesta inserció ordenada, aleshores un
buffer té l'estat de consolidable quan el temps d'una mesura de la
sèrie temporal és més gran que el següent instant de temps de
consolidació del buffer.
\begin{definition}[Buffer consolidable]\label{def:model:buffer_consolidable}
  Sigui $B=(S,\tau,\delta,f)$ un buffer, definim que $B$ és
  consolidable si i només si $T(m) \geq \tau+\delta$ a on $m=\sup(S)$
  és la mesura suprema de la sèrie temporal del buffer.
\end{definition}



\subsubsection{Disc}

Els discs reben les mesures consolidades per a emmagatzemar-les de
forma acotada. Així, tenen un operador associat que afegeix noves
mesures al disc mantenint sota control el seu cardinal.


L'operació d'afegir una mesura al disc consisteix en afegir-la a la
sèrie temporal i a eliminar la mesura mínima d'aquesta si se supera el
cardinal permès.
\begin{definition}[Afegeix mesura al disc]
  Sigui $D=(S,k)$ un disc i $m=(t,v)$ una mesura, la inserció de la
  mesura al disc $\addD(D,m)$ és un disc $D'=(S',k)$ amb la mesura
  afegida a la sèrie temporal del disc mantenint el cardinal màxim:
  $\addD(S,m) = (S',k)$ a on $S'=
  \begin{cases}
      S\cup\{m\} &\text{si }  |S|<k\\
      (S-\{\min(S)\}) \cup \{m\} &\text{altrament}
    \end{cases}$.
\end{definition}




\subsubsection{Subsèrie resolució}

Les subsèries resolució són l'aparellament d'un buffer amb un disc.
Així tenen dos operadors associats, els quals treballen amb els
operadors del buffer i del disc : un per afegir una mesura al buffer i
un altre per consolidar el buffer i afegir la mesura resultant al disc


L'operació d'afegir una mesura a la subsèrie resolució consisteix en
afegir-la al buffer.
\begin{definition}[Afegeix mesura a la subsèrie resolució]
  Sigui $R=(B,D)$ una subsèrie resolució i $m=(t,v)$ una mesura, la
  inserció de la mesura a la subsèrie resolució $\addR(R,m)$ és una
  subsèrie resolució $R'=(B',D)$ amb la mesura afegida al buffer:
  $\addR(R,m) = (B',D)$ a on $B'=\addB=(B,m)$.
\end{definition}


L'operació de consolidar una subsèrie resolució consisteix en calcular
una mesura de consolidació del buffer, en l'interval de consolidació
actual, i desar-la al disc. Una subsèrie resolució és consolidable
quan ho és el seu buffer.
\begin{definition}[Consolida la subsèrie resolució]
  Sigui $R=(B,D)$ una subsèrie resolució, la consolidació de la
  subsèrie resolució $\consR(R)$ és una subsèrie resolució
  $R'=(B',D')$ a on $(B',m') = \consB(B)$ i $D'=\addD(D,m')$.
\end{definition}





\subsubsection{Sèrie temporal multiresolució}

Les sèries temporals multiresolució són un conjunt de subsèries
resolució. Així tenen dos operadors per a treballar globalment amb
totes les subèries que contingui: un per a afegir una mesura a cada
subsèrie i un altre per a consolidar cadascuna de les subsèries.


L'operació d'afegir una mesura a la sèrie temporal multiresolució
consisteix en afegir-la a cadascuna de les subsèries resolució.
\begin{definition}[Afegeix mesura a la sèrie temporal multiresolució]
  Sigui $M=\{R_0,\dotsc,R_d\}$ una sèrie temporal multiresolució i
  $m=(t,v)$ una mesura, la inserció de la mesura a la sèrie temporal
  multiresolució $\addM(M,m)$ és una sèrie temporal multiresolució
  $M'=\{R_0',\dotsc,R_d'\}$ amb la mesura afegida a cada subsèrie
  resolució: $\addM(M,m) = \{ \forall R_i\in M: \addR(R_i,m) \}$.
\end{definition}


L'operació de consolidar una sèrie temporal multiresolució consisteix
en consolidar cadascuna de les subsèries resolució que siguin
consolidables.

\begin{definition}[Consolida la sèrie temporal multiresolució]
  Sigui $M=\{R_0,\dotsc,R_d\}$ una sèrie temporal multiresolució, la
  consolidació de la sèrie temporal multiresolució $\consM(M)$ és una
  sèrie temporal multiresolució $M'=\{R_0',\dotsc,R_d'\}$ que
  consolida les subsèries resolució consolidables:
  \[
  \consM(M) = \big\{ \forall R_i\in M:
  \begin{cases}
    \consR(R_i) & \text{si } R_i \text{ és consolidable} \\
    R_i & \text{altrament}
  \end{cases}\big\}
  \].
\end{definition}





\subsection{Manipulació de l'esquema}

El model de SGSTM associa a cada sèrie temporal un esquema de
multiresolució. En aquest apartat definim els operadors que permeten
consultar i manipular aquest esquema de multiresolució de forma
coherent amb el model de SGSTM.

L'esquema de multiresolució de cada sèrie temporal multiresolució
consisteix en quatre paràmetres variables: el darrer instant de
consolidació ($\tau$), el pas de consolidació ($\delta$), el cardinal
màxim ($k$) i la funció d'agregació d'atributs ($f$).

Així doncs, quan es manipula una base de dades multiresolució cal
conservar o tractar adequadament aquest esquema de multiresolució.  A
continuació es descriuen operadors per a poder estudiar aquest
esquema, operadors per a canviar-lo i operadors per a unir o ajuntar
dos esquemes.



\subsubsection{Propietats de l'esquema}

La configuració dels quatre paràmetres variables de l'esquema de
multiresolució confereix una sèrie de propietats als objectes d'una
base de dades multiresolució. A continuació definim algunes propietats
que es poden estudiar a partir d'un esquema de multiresolució.




Una propietat de l'esquema de multiresolució és el cronograma que se'n deriva. Així, donat un esquema de multiresolució podem dibuixar la situació relativa en el temps que prendran les mesures.
\todo{fer dibuix aclaridor}


\todo{}

  
Els paràmetres $k$, $\delta$ i $f$ d'una subsèrie resolució són fixats
per l'esquema, mentre que el paràmetre $\tau$ és fixat a un valor
inicial i va sent canviat per l'operació de consolidar. Així doncs,
les propietats que impliquin a $\tau$ dependran de l'instant temporal
en que es faci la consulta i les que no l'impliquin seran fixes per a
cada esquema.



La primera propietat que observem és el lapse temporal d'una subsèrie
resolució; és a dir una mesura de la mida temporal que ocupa la
subsèrie temporal emmagatzemada en el seu disc.
\begin{definition}[Lapse de la subsèrie resolució] %angl. span
  Sigui $R=(S_B,S_D,\tau,\delta,k,f)$ una subsèrie resolució, el seu
  lapse $\text{lapseR}(R)$ és una durada de temps $t^d$ que mesura la
  mida de l'interval que ocupa el disc: $\text{lapseR}(R) = k\delta$.
\end{definition}

\todo{} Si definim l'interval del lapse com a $[\tau - k\delta, \tau]$
i l'interval temporal real de la sèrie temporal del disc com a
$[\min(S_D),\max(S_D)]$, aleshores normalment en el cas que $\max(S_D)=\tau$ es compleix que $\min(S_D)=\tau - (k-1)\delta $: fixem-nos que això pot no complir-se (perquè la sèrie temporal no sigui regular, perquè $\tau$ i $\max(S_D)$ no coincideixin, etc.)
 fixem-nos que el lapse pot no coincidir amb
l'interval temporal real de la sèrie temporal del disc,



Com en diem a la certa variació que es correspon a $t_{actual}-\tau$?





Així doncs podem dir que un disc resolució ens cobreix un span temporal de  $\text{duradaR}(R)$. Es posiciona absolutament des de $\tau$ enrere (si no hi ha iffset). Això vol dir que tindrem un temps recent no cobert de $t_{actual}-\tau$ (anomenar-lo desfasament o retard, en angl. offset), el qual habitualment com a màxim serà de $\delta$ ($t_{actual}-\tau \leq \delta$) i com a mínim de zero si consolidem la multiresolució periòdicament.






Quin és el període de la sèrie temporal d'un disc?
  \begin{gather*}
    \text{periodeR}: R \longrightarrow \delta':\\
    \delta'=
    \begin{cases}
      \delta_r &\text{si } S_D \text{ regular o temps real amb } \delta_r\\
      \delta &\text{altrament}
    \end{cases}
  \end{gather*}


Quin disc conté més resolució?
  \begin{gather*}
    \text{maxR}: R_1 \times R_2 \longrightarrow R_i' | d_i = \max(d_1,d_2) : \\
    d_1 = periodeR(R_1), d_2 = periodeR(R_1)
  \end{gather*}



\subsubsection{Canvis en l'esquema d'un disc resolució}


Redueix o augmenta la mida d'un disc
  \begin{gather*}
    \text{CanviaK}: R \times k' \longrightarrow R': \\
    R' = (S_B,S'_D,\delta,\tau,k',f) : \\
    k_d = |S_D|:\\
    S'_D = \begin{cases}
      S_D         & \text{si } k' \geq k_d   \\
      treuN(S_D,k_d-k')    & \text{altrament}
    \end{cases}, \\
    treuN: S \times n \mapsto S'=  
    \begin{cases}
      S                & \text{si } n=0   \\
      treuN(S - \{\min(S)\},n-1)  & \text{altrament}
    \end{cases}
\end{gather*}


Redueix o augmenta el pas de consolidació d'un disc (sense canviar la sèrie temporal emmagatzemada; ja s'anirà canviant quan es consolidin noves mesures)
  \begin{gather*}
    \text{Canvia}\delta: R \times \delta' \longrightarrow R': \\
    R' = (S_B,S_D,\delta',\tau,k,f)
  \end{gather*}


Redueix o augmenta alhora el pas de consolidació i la mida d'un disc
  \begin{gather*}
    \text{CanviaK}\delta: R \times k' \times \delta' \longrightarrow R': \\
    R' = (S_B,S_D',\delta',\tau,k',f): \\    
    t = \{ \tau-n\delta' | n\in\mathbb{N},n<k' \} \\
    S_D' = \text{seleccioResolucio}(S_D,t)
  \end{gather*}




Afegeix un multivalor per a emmagatzemar sèries temporals multivaluades
  \begin{gather*}
    \text{afegeixMultivalor}: R \longrightarrow R': \\
    R' = (S'_{B},S'_{D},\delta,\tau,k,f): \\
    S'_{B} = \text{map}(S_B,(t,v)\mapsto(t,v,\infty)), \\
    S'_{D} = \text{map}(S_D,(t,v)\mapsto(t,v,\infty))
  \end{gather*}\todo{s'ha de fer amb extends i les v han de poder tenir nom}




\subsubsection{Canvis en l'esquema d'una sèrie temporal multiresolució}

Aplicació de map a una BDM.
\begin{gather*}
  \text{map}: M \times f \longrightarrow M' = \{ f(R_0), \dotsc, f(R_k) \} :\\
   \text{a on } f: R_a \mapsto R'
 \end{gather*}
 
Aplicació de fold a una BDM
\begin{gather*}
  \text{fold}: M \times M_i \times f \longrightarrow M' :\\
  = f(\dots(f(f(f(M_i,R_0),R_1),R_2)\dots),R_k), \\
   \text{a on } f: M_a \times R_b \mapsto M'
\end{gather*}





\subsubsection{Treball amb dos esquemes}


\paragraph{Unió de multiresolució}

Cas típic:
Mesuro una sèrie temporal. Durant un temps emmagatzemo valors a una
base de dades i després els emmagatzemo a una altra base de dades. Al final vull unir les dues bases de dades.


Unió de dos discs resolució que tenen el mateix $\delta$ i $f$ és un
disc resolució que conté la unió de les sèries de cada un.  Sigui
$R_1^*=(S_{B1},S_{D1},\delta,\tau_1,k_1,f)$ i
$R_2^*=(S_{B2},S_{D2},\delta,\tau_2,k_2,f)$
  \begin{gather*}
    \text{unioR}: R_1^* \times R_2^* \longrightarrow R': \\
    R' = (S'_B,S'_D,\delta,\max(\tau_1,\tau_2),k_1+k_2,f), \\
    S_{Di}, S_{Dj} | R_i = \text{maxR}(R_1,R_2), j \neq i:  \\
    S'_B = \text{unio}(S_{B1},S_{B2})\\
    S'_D = \text{unio}^r(S_{Di},S_{Dj})
\end{gather*}

També es pot unir dos discs resolució amb diferent $\delta$ i $f$,
però llavors s'ha de determinar quins són els $\delta'$ i $f'$
resultants.


Com a relacions multiresolució, dues bases de dades multiresolució es
poden unir si no intersecten en les claus $(\delta,f)$.  En cas que
intersectin, podem definir la unió multiresolució com la unió que sap unir els discs resolució repetits.

\begin{gather*}
    \text{UnioM}: M_1 \times M_2 \longrightarrow M': \\
    K_1 = \{(delta_1,f_1) \in M_1\},K_2 = \{(delta_2,f_2) \in M_2\}, \\
    K_a = K_1 \cap K_2, K_u =  (K_1 \cup K_2) - K_a : \\
    M_{u1}'= seleccio(M_1, (delta,f) \in K_u)\\
    M_{u2}'= seleccio(M_2, (delta,f) \in K_u)\\
    M_a = \{\forall R_1\in M_1,R_2\in M_2: unioR(R_1,R_2) |
       (delta_1,f_1) = (delta_2,f_2) \} \\
    M' =  M_{a} \cup  M'_{1}  \cup  M'_{2}     
\end{gather*}






\paragraph{Junció de multiresolució}

\todo{canviar fusió per junció}

Tinc una sèrie temporal en una base de dades, i una altra sèrie temporal en una altra base de dades. Vull emmagatzemar-les totes dues en una mateixa base de dades amb una sèrie temporal multivaluada.


Fusió de dos discs resolució que tenen el mateix $\delta$ i $f$.
Sigui $R_1^*=(S_{B1},S_{D1},\delta,\tau_1,k_1,f)$ i
$R_2^*=(S_{B2},S_{D2},\delta,\tau_2,k_2,f)$
  \begin{gather*}
    \text{FusioR}: R_1^* \times R_2^* \longrightarrow R': \\
    R' = (S'_B,S'_D,\delta,\max(\tau_1,\tau_2),k_1+k_2,f), \\
    S'_B = \text{fusio}^r(S_{B1},S_{B2})\\
    S'_D = \text{fusio}^r(S_{D1},S_{D2})
\end{gather*}


Fusió de dues bases de dades multiresolució
\begin{gather*}
    \text{FusioM}: M_1 \times M_2 \longrightarrow M': \\
    K_1 = \{(delta_1,f_1) \in M_1\},K_2 = \{(delta_2,f_2) \in M_2\}, \\
    K_a = K_1 \cap K_2, K_u =  (K_1 \cup K_2) - K_a : \\
    M_{u1} =\text{afegeixMultivalor}(seleccio(M_1, (delta,f) \in K_u))\\
    M_{u2} =\text{afegeixMultivalor}^{v0} (seleccio(M_2, (delta,f) \in K_u))\\
    M_1 = seleccio(M_1, (delta,f) \in K_f) \\
    M_2 = seleccio(M_2, (delta,f) \in K_f) \\
    M_a = \{\forall R_1\in M_1,R_2\in M_2: fusioR(R_1,R_2) |
       (delta_1,f_1) = (delta_2,f_2) \} \\
    M' =  M_{a} \cup  M_{u1}  \cup  M_{u2}     
\end{gather*}






\subsection{Consultes}



Operadors per fer consultes sobre una base de dades multiresolució. 

Mostrar com s'utilitzen els operadors dels SGST quan tenim multiresolució.


* Abans de fer una consulta temporal pot fer falta fer una selecció dels discs resolució amb el mateix interpolador.

* Fer una unió temporal de tots els discs de la BDM i treballar sobre aquest senyal $\longrightarrow$ Abstracció d'una BDSTM com a sèrie temporal; és possible treballar amb una BDSTM com si fos una sèrie temporal?

  - Com a consulta total: $\text{SerieTotal}(M)$

  - Com a consulta amb informació multiresolució: $\text{DiscSelecció}(M,\delta,f)$

* Pensar com operar (per exemple sumar) amb sèries temporals de diferents BDM. 




\subsubsection{Selecció de disc}


Consulta la subsèrie de la BDSTM que té una resolució i atribut
determinat. 


\begin{definition}[DiscSelecció]
  \begin{gather*}
    \text{DiscSelecció}: M \times \delta \times f \longrightarrow S' = S_D: \\
    (S_B,S_D,\delta,\tau,k,f) \in M
\end{gather*}
\end{definition}



\subsubsection{Sèrie temporal total}



\begin{definition}[Sèrie temporal total]
  Sigui $M^*$ una base de dades multiresolució a on no hi ha $\delta$ repetits
  \begin{gather*}
    \text{SerieTotal}: M^* \longrightarrow S': \\
    \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
    \delta_0 < \delta_1 < \delta_2 < \dots < \delta_d : \\
    S' = S_{D0} || S_{D1} || S_{D2} || \dotsb || S_{Dd}
\end{gather*}
\end{definition}

Prèviament es pot fer una selecció dels discs resolució que
comparteixin un determinat agregador d'atributs. \todo{També hi podria
  haver una operació estructural que sabés fusionar dos discs
  resolució}



L'operació de consulta de la sèrie temporal total també es pot aplicar
tenint en compte la representació.
\begin{definition}[Sèrie total amb representació]
  Sigui $M^*$ una base de dades multiresolució a on no hi ha $\delta$
  repetits i $r$ una representació
  \begin{gather*}
    \text{SerieTotal}: M^* \times r \longrightarrow S': \\
    \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
    \delta_0 < \delta_1 < \delta_2 < \dots < \delta_d : \\
    S' = S_{D0} \cup^r S_{D1} \cup^r  S_{D2}  \cup^r \dotsb \cup^r  S_{Dd}
\end{gather*}
\end{definition}



\paragraph{Selecció de resolució}


Per a extreure una resolució determinada de la sèrie temporal
emmagatzemada a la base de dades multiresolució, es consulta la sèrie
temporal total i s'aplica una selecció de resolució
$\text{SerieTotal}(M)[i]^r$ a on $i$ és el conjunt d'instants de
temps.






%%% Local Variables:
%%% TeX-master: "main"
%%% End:
% LocalWords:  SGSTM l'agregador buffer multiresolució subsèries
% LocalWords:  subsèrie
