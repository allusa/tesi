\section{Model d'operacions}


\subsection{Estructurals}

\subsubsection{Buffer}


Abans de consolidar, però, cal que la sèrie temporal contingui mesures. L'operació \emph{afegeix} permet afegir una mesura a un buffer.

\begin{definition}
  L'operació \emph{afegeix} afegeix una mesura a la sèrie temporal del buffer:
  \[
  \text{afegeix}: \text{Buffer} \times \text{Mesura} \longrightarrow \text{Buffer}
  \]
  \[
   B \times m \longrightarrow B'= B \cup \{m\}
   \]
\end{definition}

Cada cop que s'afegeix una mesura a un buffer es pot comprovar si el buffer ja és consolidable mitjançant un predicat que ens retorna un booleà: cert o fals. 

\begin{definition}
  Un buffer és consolidable quan el temps d'una mesura de la sèrie temporal és més gran que el proper instant de temps de consolidació:
  \[
  \text{consolidable?}: \text{Buffer} \longrightarrow \text{Booleà}
  \]
  Sigui $B=(S,\tau,\delta,f)$ un buffer i $m=\max(S)$ la mesura màxima, $B$ és consolidable si i només si $T(m) \geq \tau+\delta$
\end{definition}



Propietats:

\begin{itemize}
\item Les mesures habitualment s'insereixen ordenades en el temps,
  sinó un cop duta a terme la consolidació les mesures inserides
  desordenades poden no ser tingudes en compte.
\end{itemize}



\subsubsection{Consolidació}

Quan un buffer és consolidable, es pot calcular una mesura de consolidació de la sèrie temporal per cada interval de temps consolidable. De manera simplificada, a cada consolidació només es té en compte l'interval que comença al darrer temps de consolidació del buffer. 

Sigui $B=(S,\tau,\delta,f)$ un buffer consolidable, la mesura de consolidació de $B$ en l'interval de temps $i=[\tau,\tau+\delta]$ és $m'=(v,\tau+\delta)$ on $m'=f(S,i)$ i $f$ és un agregador d'atributs. L'operació \emph{consolida} permet consolidar la sèrie temporal del buffer calculant-ne la mesura de consolidació.

\begin{definition}
  L'operació \emph{consolida} calcula la mesura de consolidació i treu
  les mesures consolidades de la sèrie temporal del buffer, en
  l'interval de consolidació actual:
  \[
  \text{consolida}: \text{Buffer} \longrightarrow \text{Buffer} \times \text{Mesura}
  \]
  \[
  B=(S,\tau,\delta,f) \longrightarrow B' \times m'
  \]
  \[
  B'= (S',\tau+\delta,\delta,f)
  \]
  \[
  S' = S(\tau+\delta,\infty)
  \]
  \[
  m' = f(S,[\tau,\tau+\delta]): f \text{ és un agregador d'atributs}
  \]
\end{definition}
\todo{$S'$ pot ser $S$ en el model, en tot cas fer una nota que en la implementació normalment es reduirà per no ocupar espai}





\subsubsection{Disc}

L'operació \emph{afegeix} permet afegir una mesura a un disc, controlant-ne el cardinal màxim.

\begin{definition}
  L'operació \emph{afegeix} afegeix una mesura a la sèrie temporal del disc:
  \[
  \text{afegeix}: \text{Disc} \times \text{Mesura} \longrightarrow \text{Disc}
  \]
  \[
  D=(S,k) \times m \longrightarrow D'= (S',k)
  \]
  \[
  S' =  
  \begin{cases}
      S\cup\{m\} &\text{si }  |S|<k\\
      (S-\{\min(S)\}) \cup \{m\} 
    \end{cases}  \
  \]
\end{definition}





\subsubsection{Disc resolució}


Per altra banda, les operacions dels buffers i dels discs estan relacionades amb les operacions dels discs Round Robin. 

L'operació \emph{afegeix} permet afegir una mesura a un disc Round Robin.

\begin{definition}
  L'operació \emph{afegeix} afegeix una mesura al buffer del disc Round Robin:
  \[
  \text{afegir}: \text{Disc Round Robin} \times \text{Mesura} \longrightarrow \text{Disc Round Robin}
  \]
  \[
  R=(B,D) \times m \longrightarrow R'= (B',D)
  \]
  \[
  B'= B \text{ afegeix } m
  \]
\end{definition}

Cada cop que s'afegeix una mesura a un disc Round Robin es pot comprovar si ja és consolidable. 

\begin{definition}
  Un disc Round Robin és consolidable quan el seu buffer és consolidable:
  \[
  \text{consolidable?}: \text{Disc Round Robin} \longrightarrow \text{Booleà}
  \]
  Sigui $R=(B,D)$ un disc Round Robin, $R$ és consolidable si i només
  si $B$ és consolidable.
\end{definition}


Quan un disc Round Robin és consolidable, es pot consolidar amb l'operació \emph{consolida}. 

\begin{definition}
  L'operació \emph{consolida} calcula una  mesura de consolidació del buffer, en
  l'interval de consolidació actual, i la desa al disc. 
  \[
  \text{consolida}: \text{Disc Round Robin} \longrightarrow \text{Disc Round Robin}
  \]
  \[
  R=(B,D) \longrightarrow R'= (B',D')
  \]
  \[
  B' \times m'= \text{ consolida } B 
  \]
  \[
  D'= D \text{ afegeix } m'
  \]
\end{definition}





\subsubsection{Base de dades multiresolució}



With reference to the operators, the add and consolidate in a multiresolution database are applied to every resolution disc it contains.


\begin{definition}
  Operator \emph{add} adds a measure to every resolution disc:
  \[
  \text{add}: \text{multiresolution database} \times \text{Measure}
  \longrightarrow \text{multiresolution database}
  \]
  \[
  M=\{R_0,\dotsc,R_d\} \times m \mapsto M' 
  \]
  \[  
  M'= \{ \forall R_i\in M: R_i \text{ add } m \}
  \]
\end{definition}


\begin{definition}
  Operator \emph{consolidate} consolidates the resolution discs that
  are ready to consolidate.
  \[
  \text{consolidate}: \text{multiresolution database} \longrightarrow
  \text{multiresolution database}
  \]
  \[
  M=\{R_0,\dotsc,R_d\} \mapsto M'
  \]
  \[
  M'= \big\{
  \forall R_i\in M: 
  \begin{cases}
    \text{ consolidate } R_i & \text{if } R_i \text{ ready to consolidate} \\
    R_i & \text{else }
  \end{cases}\big\}
  \]
\end{definition}





\subsection{Consultes}


Abstracció d'una BDSTM com a sèrie temporal

És possible treballar amb una BDSTM com si fos una sèrie temporal?

Com a consulta total: $\text{SerieTotal}(M)$
Com a consulta amb informació multiresolució: $\text{DiscSelecció}(M,\delta,f)$


\subsubsection{Selecció de disc}


Consulta la subsèrie de la BDSTM que té una resolució i atribut
determinat. 


\begin{definition}[DiscSelecció]
  \begin{gather*}
    \text{DiscSelecció}: M \times \delta \times f \longrightarrow S' = S_D: \\
    (S_B,S_D,\delta,\tau,k,f) \in M
\end{gather*}
\end{definition}



\subsubsection{Sèrie temporal total}



\begin{definition}[Sèrie temporal total]
  Sigui $M^*$ una base de dades multiresolució a on no hi ha $\delta$ repetits
  \begin{gather*}
    \text{SerieTotal}: M^* \longrightarrow S': \\
    \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
    \delta_0 < \delta_1 < \delta_2 < \dots < \delta_d : \\
    S' = S_{D0} || S_{D1} || S_{D2} || \dotsb || S_{Dd}
\end{gather*}
\end{definition}

Prèviament es pot fer una selecció dels discs resolució que
comparteixin un determinat agregador d'atributs. \todo{També hi podria
  haver una operació estructural que sabés fusionar dos discs
  resolució}



L'operació de consulta de la sèrie temporal total també es pot aplicar
tenint en compte la representació.
\begin{definition}[Sèrie total amb representació]
  Sigui $M^*$ una base de dades multiresolució a on no hi ha $\delta$
  repetits i $r$ una representació
  \begin{gather*}
    \text{SerieTotal}: M^* \times r \longrightarrow S': \\
    \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
    \delta_0 < \delta_1 < \delta_2 < \dots < \delta_d : \\
    S' = S_{D0} \cup^r S_{D1} \cup^r  S_{D2}  \cup^r \dotsb \cup^r  S_{Dd}
\end{gather*}
\end{definition}



\paragraph{Selecció de resolució}


Per a extreure una resolució determinada de la sèrie temporal
emmagatzemada a la base de dades multiresolució, es consulta la sèrie
temporal total i s'aplica una selecció de resolució
$\text{SerieTotal}(M)[i]^r$ a on $i$ és el conjunt d'instants de
temps.






\subsection{Operacions sobre l'estructura}

* Fusió d'esquemes de BDM
* Canvis d'esquemes de BDM (afegir multivaluat, canvi de delta d'un disc,canvi de la k,...)
* Estudiar Push o pull?




\subsubsection{Estudis en l'esquema}

Quin és el període de la sèrie temporal d'un disc?
  \begin{gather*}
    \text{periodeR}: R \longrightarrow \delta':\\
    \delta'=
    \begin{cases}
      \delta_r &\text{si } S_D \text{ regular o temps real amb } \delta_r\\
      \delta &\text{altrament}
    \end{cases}
  \end{gather*}
  
Quin és el l'interval temporal de la sèrie temporal d'un disc?
  \begin{gather*}
    \text{intervalR}: R \longrightarrow [T_0,T_f] :\\
    T_0 = T(\min(S_D)),     T_f = T(\max(S_D))
  \end{gather*}

Quin és el lapse temporal d'un disc?
  \begin{gather*}
    \text{lapseR}: R \longrightarrow [T_0,T_f] :\\
    T_0 = \tau - k\delta,  T_f = \tau
  \end{gather*}




Quin disc conté més resolució?
  \begin{gather*}
    \text{maxR}: R_1 \times R_2 \longrightarrow R_i' | d_i = \max(d_1,d_2) : \\
    d_1 = periodeR(R_1), d_2 = periodeR(R_1)
  \end{gather*}
  





\subsubsection{Canvis en l'esquema}


Redueix o augmenta la mida d'un disc
  \begin{gather*}
    \text{CanviaK}: R \times k' \longrightarrow R': \\
    R' = (S_B,S'_D,\delta,\tau,k',f) : \\
    k_d = |S_D|:\\
    S'_D = \begin{cases}
      S_D         & \text{si } k' \geq k_d   \\
      treuN(S_D,k_d-k')    & \text{altrament}
    \end{cases}, \\
    treuN: S \times n \mapsto S'=  
    \begin{cases}
      S                & \text{si } n=0   \\
      treuN(S - \{\min(S)\},n-1)  & \text{altrament}
    \end{cases}
\end{gather*}


Redueix o augmenta el pas de consolidació d'un disc (sense canviar la sèrie temporal emmagatzemada; ja s'anirà canviant quan es consolidin noves mesures)
  \begin{gather*}
    \text{Canvia}\delta: R \times \delta' \longrightarrow R': \\
    R' = (S_B,S_D,\delta',\tau,k,f)
  \end{gather*}


Redueix o augmenta alhora el pas de consolidació i la mida d'un disc
  \begin{gather*}
    \text{CanviaK}\delta: R \times k' \times \delta' \longrightarrow R': \\
    R' = (S_B,S_D',\delta',\tau,k',f): \\    
    t = \{ \tau-n\delta' | n\in\mathbb{N},n<k' \} \\
    S_D' = \text{seleccioResolucio}(S_D,t)
  \end{gather*}




Afegeix un multivalor per a emmagatzemar sèries temporals multivaluades
  \begin{gather*}
    \text{afegeixMultivalor}: R \longrightarrow R': \\
    R' = (S'_{B},S'_{D},\delta,\tau,k,f): \\
    S'_{B} = \text{map}(S_B,(t,v)\mapsto(t,v,\infty)), \\
    S'_{D} = \text{map}(S_D,(t,v)\mapsto(t,v,\infty))
  \end{gather*}





\subsubsection{Unió de multiresolució}

Cas típic:
Mesuro una sèrie temporal. Durant un temps emmagatzemo valors a una
base de dades i després els emmagatzemo a una altra base de dades. Al final vull unir les dues bases de dades.


Unió de dos discs resolució que tenen el mateix $\delta$ i $f$ és un
disc resolució que conté la unió de les sèries de cada un.  Sigui
$R_1^*=(S_{B1},S_{D1},\delta,\tau_1,k_1,f)$ i
$R_2^*=(S_{B2},S_{D2},\delta,\tau_2,k_2,f)$
  \begin{gather*}
    \text{unioR}: R_1^* \times R_2^* \longrightarrow R': \\
    R' = (S'_B,S'_D,\delta,\max(\tau_1,\tau_2),k_1+k_2,f), \\
    S_{Di}, S_{Dj} | R_i = \text{maxR}(R_1,R_2), j \neq i:  \\
    S'_B = \text{unio}(S_{B1},S_{B2})\\
    S'_D = \text{unio}^r(S_{Di},S_{Dj})
\end{gather*}

També es pot unir dos discs resolució amb diferent $\delta$ i $f$,
però llavors s'ha de determinar quins són els $\delta'$ i $f'$
resultants.


Com a relacions multiresolució, dues bases de dades multiresolució es
poden unir si no intersecten en les claus $(\delta,f)$.  En cas que
intersectin, podem definir la unió multiresolució com la unió que sap unir els discs resolució repetits.

\begin{gather*}
    \text{UnioM}: M_1 \times M_2 \longrightarrow M': \\
    K_1 = \{(delta_1,f_1) \in M_1\},K_2 = \{(delta_2,f_2) \in M_2\}, \\
    K_a = K_1 \cap K_2, K_u =  (K_1 \cup K_2) - K_f : \\
    M_{u1}'= seleccio(M_1, (delta,f) \in K_u)\\
    M_{u2}'= seleccio(M_2, (delta,f) \in K_u)\\
    M_1 = seleccio(M_1, (delta,f) \in K_f) \\
    M_2 = seleccio(M_2, (delta,f) \in K_f) \\
    M_u = \{\forall R_1\in M_1,R_2\in M_2: unioR(R_1,R_2) |
       (delta_1,f_1) = (delta_2,f_2) \} \\
    M' =  M_{a} \cup  M'_{1}  \cup  M'_{2}     
\end{gather*}






\subsubsection{Fusió de multiresolució}

Tinc una sèrie temporal en una base de dades, i una altra sèrie temporal en una altra base de dades. Vull emmagatzemar-les totes dues en una mateixa base de dades amb una sèrie temporal multivaluada.


Fusió de dos discs resolució que tenen el mateix $\delta$ i $f$.
Sigui $R_1^*=(S_{B1},S_{D1},\delta,\tau_1,k_1,f)$ i
$R_2^*=(S_{B2},S_{D2},\delta,\tau_2,k_2,f)$
  \begin{gather*}
    \text{FusioR}: R_1^* \times R_2^* \longrightarrow R': \\
    k^M=\max(k_1,k_2), R' = (S'_B,S'_D,\delta,\max(\tau_1,\tau_2),k^M,f), \\
    S^M_D = S_{Di} | k_i = k_M,  S^m_D = S_{Di} | k_i \neq k^M   : \\
    S'_B = \text{fusio}^r(S_{B1},S_{B2})\\
    S'_D = \text{semifusio}^r(S^M_{D},S^m_{D})
\end{gather*}


Fusió de dues bases de dades multiresolució

\begin{gather*}
    \text{FusioM}: M_1 \times M_2 \longrightarrow M': \\
    K_1 = \{(delta_1,f_1) \in M_1\},K_2 = \{(delta_2,f_2) \in M_2\}, \\
    K_f = K_1 \cap K_2, K_u =  (K_1 \cup K_2) - K_f : \\
    M_1'=\text{afegeixMultivalor}(seleccio(M_1, (delta,f) \in K_u))\\
    M_2'=\text{afegeixMultivalor*} (seleccio(M_2, (delta,f) \in K_u))\\
    \text{afegeixMultivalor*: com a }v_1\\
    M_{f1} = seleccio(M_1, (delta,f) \in K_f) \\
    M_{f2} = seleccio(M_2, (delta,f) \in K_f) \\
    M_f = \{\forall R_1\in M_1,R_2\in M_2: fusioR(R_1,R_2) |
       (delta_1,f_1) = (delta_2,f_2) \in K_u  \} \\
    M' =  M_{f} \cup  M'_{1}  \cup  M'_{2}     
\end{gather*}\todo{repensar perquè $|S_{D1} \cup S_{D2}| = k$?} 




\subsection{Com treure profit de les operacions dels SGSTM}

Temes que després es poden aprofitar a les implementacions

* No hi ha updates --> les sèries temporals no s'han de canviar

* Per exemple, vull calcular la mitjana de  BDSTM(a,b] si tinc un disc resolució amb $\delta=b-a$ i $f=$mitjana aquest seria l'adequat en comptes de calcular mitjana(SerieTotal(M)(a,b])

%??
% No obstant, la base de dades multiresolució conté informació sobre la
% resolució de les subsèries i per tant aquesta operació és susceptible
% d'implementar-se aprofitant aquesta informació.  A tall d'exemple es
% defineix una operació per extreure de la base de dades multiresolució
% una sèrie temporal regular amb període $T$:


% \begin{definition}[Selecció de resolució regular]
%   \begin{gather*}
%     \text{ResolucióRegular}: M^* \times T \times r \longrightarrow S'\\
%     \forall (S_{Bi},S_{Di},\delta_i,\tau_i,k_i,f_i) \in M : \\
%     d_i = T - \delta_i , \\
%     0 \geq d_0 > d_1 \dots > d_a, 0 < d_{a+1} < \dots < d_d: \\
%     S'' = S_{D0} || S_{D1} || \dotsb || S_{Da}  ||  S_{Da+1} || \dotsb || S_{Dd}, \\
%     S' = S''[i]^r: i = {t|0+nT,n\in\mathbb{N}}
%   \end{gather*}
% \end{definition}

% Nota: les operacions no són equivalents, l'operació $\text{SerieTotal}(M)[i]^r$ és molt més potent que la $\text{ResolucióRegular}(M,T)$.







%%% Local Variables:
%%% TeX-master: "main"
%%% End:
% LocalWords:  SGSTM
